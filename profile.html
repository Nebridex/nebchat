<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NebChat • Profilim</title>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Pacifico&display=swap");

    body {
      margin: 0;
      font-family: "Montserrat", sans-serif;
      background: #080d1a;
      color: #e0e4ff;
    }

    header {
      background: rgba(15, 20, 40, 0.9);
      backdrop-filter: blur(10px);
      padding: 18px 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(80, 100, 255, 0.25);
      box-shadow: 0 0 18px rgba(0, 162, 255, 0.25);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .logo-title {
      font-family: "Pacifico", cursive;
      font-size: 28px;
      color: #8ab4ff;
      text-shadow: 0 0 10px rgba(121, 169, 255, 0.9);
    }

    .menu {
      display: flex;
      gap: 16px;
    }

    .menu a {
      color: #a8b4ff;
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(108, 99, 255, 0.3);
      background: rgba(255, 255, 255, 0.03);
      transition: 0.25s;
    }

    .menu a:hover {
      background: rgba(108, 99, 255, 0.3);
      box-shadow: 0 0 14px rgba(108, 99, 255, 0.6);
      color: #ffffff;
    }

    main {
      max-width: 1000px;
      margin: 30px auto 60px;
      padding: 0 16px;
    }

    .page-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #dfe6ff;
      text-shadow: 0 0 16px rgba(120, 140, 255, 0.7);
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 20px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: rgba(14, 18, 40, 0.98);
      border-radius: 20px;
      padding: 18px 16px;
      border: 1px solid rgba(108, 99, 255, 0.4);
      box-shadow: 0 0 22px rgba(80, 70, 230, 0.45);
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #d7e2ff;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .tab {
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 999px;
      border: 1px solid rgba(108, 99, 255, 0.4);
      cursor: pointer;
      background: rgba(7, 12, 30, 0.9);
      color: #cfd7ff;
    }

    .tab.active {
      background: rgba(108, 99, 255, 0.85);
      border-color: rgba(108, 99, 255, 0.95);
      color: #ffffff;
      box-shadow: 0 0 18px rgba(108, 99, 255, 0.7);
    }

    .form-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 10px;
    }

    label {
      font-size: 12px;
      color: #a3aedf;
    }

    input {
      background: rgba(7, 12, 30, 0.9);
      border: 1px solid rgba(108, 99, 255, 0.4);
      padding: 8px 10px;
      border-radius: 10px;
      color: #ffffff;
      font-size: 13px;
      outline: none;
    }

    input:focus {
      border-color: rgba(138, 127, 255, 0.9);
      box-shadow: 0 0 14px rgba(138, 127, 255, 0.7);
    }

    .btn-main {
      padding: 8px 14px;
      border-radius: 10px;
      border: 1px solid rgba(108, 99, 255, 0.7);
      background: rgba(108, 99, 255, 0.85);
      color: #e0e4ff;
      font-size: 13px;
      cursor: pointer;
      transition: 0.25s;
    }

    .btn-main:hover {
      background: rgba(108, 99, 255, 1);
      box-shadow: 0 0 18px rgba(108, 99, 255, 0.8);
    }

    .btn-secondary {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid rgba(200, 80, 80, 0.7);
      background: rgba(80, 20, 20, 0.7);
      color: #ffe0e0;
      font-size: 12px;
      cursor: pointer;
    }

    .hint {
      font-size: 11px;
      color: #a3aedf;
      margin-top: 4px;
    }

    .warning {
      font-size: 11px;
      color: #feb2b2;
      margin-top: 4px;
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .avatar {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #9ad0ff, #5f8cff 45%, #3a4bff 80%);
      box-shadow: 0 0 22px rgba(95, 140, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 22px;
      color: #ffffff;
    }

    .username-line {
      font-size: 16px;
      font-weight: 600;
      color: #e0e7ff;
    }

    .user-tag {
      font-size: 11px;
      color: #a3aedf;
      margin-top: 2px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-top: 12px;
    }

    .stat-box {
      background: rgba(10, 14, 32, 0.98);
      border-radius: 14px;
      padding: 8px;
      border: 1px solid rgba(108, 99, 255, 0.35);
      font-size: 12px;
    }

    .stat-label {
      color: #a3aedf;
      margin-bottom: 2px;
    }

    .stat-value {
      font-size: 16px;
      font-weight: 600;
      color: #f7fafc;
    }

    .nebscore-text {
      margin-top: 8px;
      font-size: 11px;
      color: #9ca6e0;
    }

    .section-sub {
      font-size: 12px;
      color: #a3aedf;
      margin-bottom: 6px;
    }

    footer {
      margin-top: 40px;
      padding: 20px;
      text-align: center;
      font-size: 12px;
      color: #8189c4;
    }
  </style>
</head>

<body>
<header>
  <a href="index.html" style="text-decoration:none;">
    <div class="logo-title">NebChat</div>
  </a>

  <nav class="menu">
    <a href="index.html">Ana Sayfa</a>
    <a href="forum.html">Forum</a>
    <a href="profile.html">Profilim</a>
  </nav>
</header>

<main>
  <h1 class="page-title">Profil & Hesap</h1>
  <div class="grid">
    <!-- AUTH KISMI -->
    <div class="card" id="authCard">
      <div class="card-title">Giriş / Kayıt</div>
      <div class="tabs">
        <button class="tab active" id="tabLogin">Giriş Yap</button>
        <button class="tab" id="tabRegister">Kayıt Ol</button>
      </div>

      <div id="loginForm">
        <div class="form-row">
          <label for="loginEmail">E-posta</label>
          <input type="email" id="loginEmail" autocomplete="email" />
        </div>
        <div class="form-row">
          <label for="loginPassword">Şifre</label>
          <input type="password" id="loginPassword" autocomplete="current-password" />
        </div>
        <button class="btn-main" id="loginBtn">Giriş Yap</button>
        <div class="hint">
          Giriş yaptıktan sonra forumda yazdığın tüm mesajlar
          <strong>kayıtlı kullanıcı adı</strong> ile görünecek.
        </div>
      </div>

      <div id="registerForm" style="display:none;">
        <div class="form-row">
          <label for="regEmail">E-posta</label>
          <input type="email" id="regEmail" autocomplete="email" />
        </div>
        <div class="form-row">
          <label for="regPassword">Şifre (min 6 karakter)</label>
          <input type="password" id="regPassword" autocomplete="new-password" />
        </div>
        <div class="form-row">
          <label for="regUsername">Kullanıcı adı (forumdaki nick’in)</label>
          <input type="text" id="regUsername" placeholder="Nebride" />
        </div>
        <button class="btn-main" id="registerBtn">Kayıt Ol</button>
        <div class="hint">
          • Kullanıcı adın benzersizdir, başkası kullanamaz.<br />
          • Harf/rakam, 3–20 karakter, boşluk yok. “Nebride” gibi.
        </div>
      </div>
    </div>

    <!-- PROFİL KISMI -->
    <div class="card" id="profileCard" style="display:none;">
      <div class="card-title">Profil</div>
      <div class="profile-header">
        <div class="avatar" id="avatar">N</div>
        <div>
          <div class="username-line" id="usernameDisplay">Kullanıcı</div>
          <div class="user-tag" id="userMeta">–</div>
        </div>
      </div>

      <div class="section-sub">Kullanıcı adını güncelle</div>
      <div class="form-row">
        <label for="usernameEdit">Kullanıcı adı</label>
        <input type="text" id="usernameEdit" />
      </div>
      <button class="btn-main" id="updateUsernameBtn">Kullanıcı adını kaydet</button>
      <div class="warning">
        Bu ad benzersizdir. Kaydettikten sonra forumda senin dışındaki hiç kimse bu nick’i kullanamaz.
      </div>

      <hr style="margin:16px 0;border-color:rgba(80,90,160,0.6);" />

      <div class="section-sub">Forum istatistiklerin</div>
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-label">Mesaj</div>
          <div class="stat-value" id="statMessages">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Konular</div>
          <div class="stat-value" id="statTopics">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Beğeniler</div>
          <div class="stat-value" id="statLikes">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">NebScore</div>
          <div class="stat-value" id="statScore">0</div>
        </div>
      </div>
      <div class="nebscore-text">
        NebScore = likes × 2 + messages × 1.5 + topics × 3<br />
        Girişli yazdığın her mesaj ve aldığın beğeni buraya işler.
      </div>

      <div style="margin-top:16px;">
        <button class="btn-secondary" id="logoutBtn">Çıkış Yap</button>
      </div>
    </div>
  </div>
</main>

<footer>
  NebChat • Profil sayfası • Kullanıcı adları kayıtlıdır, taklit edilemez.
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    updateDoc,
    serverTimestamp,
    collection,
    query,
    where,
    getDocs
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBAwFSe0pud59OXpx1G5hQO9opA1f7Eg9Y",
    authDomain: "nebchat2.firebaseapp.com",
    projectId: "nebchat2",
    storageBucket: "nebchat2.firebasestorage.app",
    messagingSenderId: "46979426016",
    appId: "1:46979426016:web:fd1fbe341fff6970ae9285"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM
  const tabLogin = document.getElementById("tabLogin");
  const tabRegister = document.getElementById("tabRegister");
  const loginForm = document.getElementById("loginForm");
  const registerForm = document.getElementById("registerForm");

  const loginEmail = document.getElementById("loginEmail");
  const loginPassword = document.getElementById("loginPassword");
  const loginBtn = document.getElementById("loginBtn");

  const regEmail = document.getElementById("regEmail");
  const regPassword = document.getElementById("regPassword");
  const regUsername = document.getElementById("regUsername");
  const registerBtn = document.getElementById("registerBtn");

  const profileCard = document.getElementById("profileCard");
  const authCard = document.getElementById("authCard");
  const avatarDiv = document.getElementById("avatar");
  const usernameDisplay = document.getElementById("usernameDisplay");
  const userMeta = document.getElementById("userMeta");
  const usernameEdit = document.getElementById("usernameEdit");
  const updateUsernameBtn = document.getElementById("updateUsernameBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  const statMessages = document.getElementById("statMessages");
  const statTopics = document.getElementById("statTopics");
  const statLikes = document.getElementById("statLikes");
  const statScore = document.getElementById("statScore");

  let currentUser = null;
  let currentUserData = null;

  function switchTab(mode) {
    if (mode === "login") {
      tabLogin.classList.add("active");
      tabRegister.classList.remove("active");
      loginForm.style.display = "block";
      registerForm.style.display = "none";
    } else {
      tabLogin.classList.remove("active");
      tabRegister.classList.add("active");
      loginForm.style.display = "none";
      registerForm.style.display = "block";
    }
  }

  tabLogin.addEventListener("click", () => switchTab("login"));
  tabRegister.addEventListener("click", () => switchTab("register"));

  function validateUsername(name) {
    if (!name) return false;
    const trimmed = name.trim();
    if (trimmed.length < 3 || trimmed.length > 20) return false;
    if (/\s/.test(trimmed)) return false;
    return true;
  }

  async function isUsernameTaken(username, excludeUid = null) {
    const lower = username.trim().toLowerCase();
    const q = query(collection(db, "users"), where("usernameLower", "==", lower));
    const snap = await getDocs(q);
    if (snap.empty) return false;
    const docs = snap.docs.filter((d) => d.id !== excludeUid);
    return docs.length > 0;
  }

  async function ensureUserDoc(user) {
    const ref = doc(db, "users", user.uid);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      const fallbackName =
        (user.email && user.email.split("@")[0]) || "user-" + user.uid.slice(0, 6);
      await setDoc(ref, {
        username: fallbackName,
        usernameLower: fallbackName.toLowerCase(),
        createdAt: serverTimestamp(),
        stats: {
          messages: 0,
          topics: 0,
          likes: 0
        }
      });
      return (await getDoc(ref)).data();
    } else {
      const data = snap.data();
      // Eski kullanıcılar için usernameLower alanı yoksa ekle
      if (data.username && !data.usernameLower) {
        await updateDoc(ref, {
          usernameLower: data.username.toLowerCase()
        });
        data.usernameLower = data.username.toLowerCase();
      }
      if (!data.stats) {
        await updateDoc(ref, {
          stats: { messages: 0, topics: 0, likes: 0 }
        });
        data.stats = { messages: 0, topics: 0, likes: 0 };
      }
      return data;
    }
  }

  loginBtn.addEventListener("click", async () => {
    try {
      const email = loginEmail.value.trim();
      const pass = loginPassword.value;
      if (!email || !pass) {
        alert("E-posta ve şifre zorunlu.");
        return;
      }
      await signInWithEmailAndPassword(auth, email, pass);
    } catch (e) {
      console.error("Giriş hatası:", e);
      alert("Giriş hatası: " + e.message);
    }
  });

  registerBtn.addEventListener("click", async () => {
    try {
      const email = regEmail.value.trim();
      const pass = regPassword.value;
      const username = regUsername.value.trim();

      if (!email || !pass || !username) {
        alert("Tüm alanlar zorunlu.");
        return;
      }
      if (!validateUsername(username)) {
        alert("Kullanıcı adı 3-20 karakter, boşluksuz olmalı.");
        return;
      }
      if (await isUsernameTaken(username)) {
        alert("Bu kullanıcı adı zaten alınmış.");
        return;
      }

      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      const uid = cred.user.uid;
      await setDoc(doc(db, "users", uid), {
        username,
        usernameLower: username.toLowerCase(),
        createdAt: serverTimestamp(),
        stats: {
          messages: 0,
          topics: 0,
          likes: 0
        }
      });
      // onAuthStateChanged devreye girecek
    } catch (e) {
      console.error("Kayıt hatası:", e);
      alert("Kayıt hatası: " + e.message);
    }
  });

  updateUsernameBtn.addEventListener("click", async () => {
    if (!currentUser) return;
    const newName = usernameEdit.value.trim();
    if (!validateUsername(newName)) {
      alert("Kullanıcı adı 3-20 karakter, boşluksuz olmalı.");
      return;
    }
    if (await isUsernameTaken(newName, currentUser.uid)) {
      alert("Bu kullanıcı adı zaten başka biri tarafından kullanılıyor.");
      return;
    }
    const ref = doc(db, "users", currentUser.uid);
    await updateDoc(ref, {
      username: newName,
      usernameLower: newName.toLowerCase()
    });
    currentUserData.username = newName;
    currentUserData.usernameLower = newName.toLowerCase();
    renderProfile();
    alert("Kullanıcı adın güncellendi.");
  });

  logoutBtn.addEventListener("click", async () => {
    try {
      await signOut(auth);
    } catch (e) {
      console.error("Çıkış hatası:", e);
      alert("Çıkış yapılırken hata oluştu.");
    }
  });

  function renderProfile() {
    if (!currentUser || !currentUserData) return;

    const username = currentUserData.username || "Kullanıcı";
    avatarDiv.textContent = username.charAt(0).toUpperCase();
    usernameDisplay.textContent = username;

    const email = currentUser.email || "";
    userMeta.textContent = email ? `${email}` : "E-posta yok";

    usernameEdit.value = username;

    const messages = currentUserData.stats?.messages || 0;
    const topics = currentUserData.stats?.topics || 0;
    const likes = currentUserData.stats?.likes || 0;
    const nebScore = likes * 2 + messages * 1.5 + topics * 3;

    statMessages.textContent = messages;
    statTopics.textContent = topics;
    statLikes.textContent = likes;
    statScore.textContent = Math.round(nebScore);
  }

  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    currentUserData = null;

    if (!user) {
      authCard.style.display = "block";
      profileCard.style.display = "none";
      return;
    }

    try {
      const data = await ensureUserDoc(user);
      currentUserData = data;

      authCard.style.display = "none";
      profileCard.style.display = "block";
      renderProfile();
    } catch (e) {
      console.error("Profil yükleme hatası:", e);
    }
  });
</script>

</body>
</html>
