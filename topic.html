<!-- topic.html with category display -->
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NebChat ‚Ä¢ Konu Detayƒ±</title>
  <!-- styles omitted for brevity; keep your existing CSS -->
</head>
<body>
<!-- ... keep your existing HTML layout ... -->

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    doc,
    updateDoc,
    increment,
    serverTimestamp,
    query,
    orderBy,
    onSnapshot,
    getDoc
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBAwFSe0pud59OXpx1G5hQO9opA1f7Eg9Y",
    authDomain: "nebchat2.firebaseapp.com",
    projectId: "nebchat2",
    storageBucket: "nebchat2.firebasestorage.app",
    messagingSenderId: "46979426016",
    appId: "1:46979426016:web:fd1fbe341fff6970ae9285"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const categoryMap = {
    genel: "‚ö° Genel Sohbet",
    oyun: "üéÆ Oyun Sohbeti",
    teknoloji: "üí° Teknoloji K√∂≈üesi"
  };

  const params = new URLSearchParams(window.location.search);
  const postId = params.get("id");

  const topicTitleEl = document.getElementById("topicTitle");
  const topicMetaEl = document.getElementById("topicMeta");
  const topicMessageEl = document.getElementById("topicMessage");
  const messagesListEl = document.getElementById("messages-list");
  const nicknameInput = document.getElementById("nickname");
  const messageInput = document.getElementById("message");
  const replyBtn = document.getElementById("replyBtn");

  if (!postId) {
    topicTitleEl.textContent = "Konu bulunamadƒ±";
    topicMetaEl.textContent = "Ge√ßersiz baƒülantƒ±.";
  } else {
    loadTopic(postId);
    listenReplies(postId);
  }

  async function loadTopic(id) {
    try {
      const ref = doc(db, "posts", id);
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        topicTitleEl.textContent = "Konu bulunamadƒ±";
        topicMetaEl.textContent = "";
        topicMessageEl.textContent = "";
        return;
      }

      const data = snap.data();

      // CATEGORY DISPLAY
      const categoryText = categoryMap[data.category] || "";

      let timeText = "";
      if (data.createdAt && data.createdAt.toDate) {
        const d = data.createdAt.toDate();
        timeText = d.toLocaleString("tr-TR", {
          day: "2-digit",
          month: "2-digit",
          hour: "2-digit",
          minute: "2-digit"
        });
      }

      topicTitleEl.textContent = `${categoryText} ${data.title || "Ba≈ülƒ±ksƒ±z Konu"}`;
      topicMetaEl.textContent = `Kategori: ${categoryText} ‚Ä¢ A√ßan: ${data.nick || "Anonim"} ‚Ä¢ ${timeText}`;
      topicMessageEl.textContent = data.message || "";

    } catch (e) {
      console.error("Konu y√ºklenirken hata:", e);
      topicTitleEl.textContent = "Konu y√ºklenirken hata olu≈ütu";
    }
  }

  function listenReplies(id) {
    const repliesRef = collection(db, "posts", id, "replies");
    const q = query(repliesRef, orderBy("createdAt", "asc"));

    onSnapshot(q, (snapshot) => {
      messagesListEl.innerHTML = "";

      if (snapshot.empty) {
        const p = document.createElement("p");
        p.className = "no-comment";
        p.textContent = "Hen√ºz yorum yok. ƒ∞lk yorumu sen yaz üòä";
        messagesListEl.appendChild(p);
        return;
      }

      snapshot.forEach((docSnap) => {
        const data = docSnap.data();

        const card = document.createElement("div");
        card.className = "message-card";

        const userRow = document.createElement("div");
        userRow.className = "msg-user";

        const avatar = document.createElement("div");
        avatar.className = "msg-avatar";
        avatar.textContent = (data.nick || "?").charAt(0).toUpperCase();

        const nameBlock = document.createElement("div");
        const name = document.createElement("div");
        name.className = "msg-username";
        name.textContent = data.nick || "Anonim";

        const time = document.createElement("div");
        time.className = "msg-time";

        let t = "";
        if (data.createdAt && data.createdAt.toDate) {
          const d = data.createdAt.toDate();
          t = d.toLocaleString("tr-TR", {
            day: "2-digit",
            month: "2-digit",
            hour: "2-digit",
            minute: "2-digit"
          });
        }
        time.textContent = t || "";

        nameBlock.appendChild(name);
        nameBlock.appendChild(time);

        userRow.appendChild(avatar);
        userRow.appendChild(nameBlock);

        const text = document.createElement("div");
        text.className = "msg-text";
        text.textContent = data.message || "";

        card.appendChild(userRow);
        card.appendChild(text);

        messagesListEl.appendChild(card);
      });
    });
  }

  replyBtn.addEventListener("click", async () => {
    if (!postId) {
      alert("Ge√ßersiz konu.");
      return;
    }

    const nick = nicknameInput.value.trim();
    const text = messageInput.value.trim();

    if (!nick || !text) {
      alert("L√ºtfen hem nick hem de yorumu doldur.");
      return;
    }

    try {
      const repliesRef = collection(db, "posts", postId, "replies");
      await addDoc(repliesRef, {
        nick,
        message: text,
        createdAt: serverTimestamp()
      });

      const postRef = doc(db, "posts", postId);
      await updateDoc(postRef, {
        replyCount: increment(1),
        lastReplyAt: serverTimestamp()
      });

      messageInput.value = "";
    } catch (e) {
      console.error("Yorum eklenirken hata:", e);
      alert("Yorum eklenirken bir hata olu≈ütu.");
    }
  });
</script>

</body>
</html>
