<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NebChat â€¢ Konu DetayÄ±</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Pacifico&display=swap');

    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background: #080d1a;
      color: #e0e4ff;
    }

    /* HEADER + MENÃœ */
    header {
      background: rgba(15, 20, 40, 0.7);
      padding: 18px 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(80, 100, 255, 0.25);
      box-shadow: 0 0 18px rgba(0, 162, 255, 0.25);
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
    }

    .logo-area {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .logo-title {
      font-family: 'Pacifico', cursive;
      font-size: 34px;
      font-weight: 400;
      color: #8ab4ff;
      text-shadow: 0 0 10px rgba(121, 169, 255, 0.9);
      letter-spacing: 0.5px;
    }

    .menu {
      display: flex;
      gap: 16px;
    }

    .menu a {
      color: #a8b4ff;
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid rgba(108, 99, 255, 0.3);
      background: rgba(255, 255, 255, 0.03);
      transition: 0.25s;
    }

    .menu a:hover {
      background: rgba(108, 99, 255, 0.25);
      box-shadow: 0 0 14px rgba(108, 99, 255, 0.5);
      color: #ffffff;
    }

    @media (max-width: 700px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      .menu {
        flex-wrap: wrap;
      }
    }

    /* SAYFA Ä°Ã‡ERÄ°ÄžÄ° */
    .container {
      max-width: 900px;
      margin: 30px auto 60px;
      padding: 0 16px;
    }

    .topic-header {
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(120, 140, 255, 0.25);
    }

    .topic-title {
      font-size: 24px;
      font-weight: 700;
      color: #bcd2ff;
      text-shadow: 0 0 12px rgba(140, 160, 255, 0.5);
      margin-bottom: 6px;
    }

    .topic-meta {
      font-size: 13px;
      opacity: 0.85;
      color: #a8b4ff;
      margin-bottom: 10px;
    }

    .topic-message {
      font-size: 14px;
      line-height: 1.6;
      color: #dde4ff;
      white-space: pre-wrap;
      background: rgba(20, 25, 45, 0.7);
      padding: 14px;
      border-radius: 14px;
      border: 1px solid rgba(108, 99, 255, 0.3);
      box-shadow: 0 0 18px rgba(90, 80, 250, 0.35);
    }

    .back-link {
      font-size: 13px;
      margin-bottom: 8px;
    }

    .back-link a {
      color: #9fb4ff;
      text-decoration: none;
    }

    .back-link a:hover {
      text-decoration: underline;
    }

    .message-card {
      background: rgba(20, 25, 45, 0.65);
      padding: 16px;
      border-radius: 15px;
      margin-bottom: 14px;
      border: 1px solid rgba(108, 99, 255, 0.25);
      box-shadow: 0 0 18px rgba(88, 80, 255, 0.25);
      transition: 0.2s;
    }

    .message-card:hover {
      border-color: rgba(108, 99, 255, 0.45);
      box-shadow: 0 0 24px rgba(88, 80, 255, 0.4);
    }

    .msg-user {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }

    .msg-avatar {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: #6d6cff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 17px;
      box-shadow: 0 0 10px rgba(120, 140, 255, 0.8);
    }

    .msg-username {
      font-size: 14px;
      font-weight: 600;
      color: #cdd7ff;
    }

    .msg-time {
      font-size: 11px;
      color: #9ea8e0;
      opacity: 0.9;
    }

    .msg-text {
      font-size: 14px;
      line-height: 1.5;
      color: #dbe2ff;
      margin-top: 4px;
      white-space: pre-wrap;
    }

    .reply-box {
      margin-top: 30px;
      background: rgba(20, 25, 45, 0.7);
      padding: 16px;
      border-radius: 15px;
      border: 1px solid rgba(108, 99, 255, 0.35);
      box-shadow: 0 0 22px rgba(88, 80, 255, 0.25);
    }

    .reply-title {
      font-size: 16px;
      margin-bottom: 10px;
      color: #cdd7ff;
      text-shadow: 0 0 8px rgba(140, 160, 255, 0.6);
    }

    .input-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .input-row input {
      flex: 1;
      min-width: 140px;
      padding: 9px;
      border-radius: 10px;
      border: 1px solid rgba(108, 99, 255, 0.4);
      background: rgba(255, 255, 255, 0.07);
      color: #ffffff;
      outline: none;
      font-size: 13px;
    }

    textarea {
      width: 100%;
      height: 120px;
      border-radius: 12px;
      border: 1px solid rgba(108, 99, 255, 0.35);
      background: rgba(255, 255, 255, 0.08);
      padding: 10px;
      color: white;
      outline: none;
      font-size: 14px;
      resize: vertical;
      transition: 0.25s;
    }

    textarea:focus,
    .input-row input:focus {
      border-color: rgba(138, 127, 255, 0.9);
      box-shadow: 0 0 15px rgba(138, 127, 255, 0.7);
    }

    .reply-button {
      margin-top: 10px;
      width: 100%;
      padding: 10px;
      background: rgba(108, 99, 255, 0.4);
      border: 1px solid rgba(108, 99, 255, 0.7);
      border-radius: 10px;
      color: #e0e4ff;
      font-size: 15px;
      cursor: pointer;
      transition: 0.25s;
    }

    .reply-button:hover {
      background: rgba(108, 99, 255, 0.55);
      box-shadow: 0 0 22px rgba(108, 99, 255, 0.75);
    }

    .info-text {
      font-size: 11px;
      margin-top: 6px;
      color: #a4aedf;
      opacity: 0.85;
    }

    .no-comment {
      font-size: 13px;
      color: #969fdd;
      margin-top: 8px;
    }
  </style>
</head>

<body>

<header>
  <div class="logo-area">
    <a href="index.html" style="display:flex;align-items:center;gap:14px;text-decoration:none;">
      <div class="logo-title">NebChat</div>
    </a>
  </div>

  <nav class="menu">
    <a href="index.html">Ana Sayfa</a>
    <a href="forum.html">Forum</a>
    <a href="login.html">GiriÅŸ Yap</a>
    <a href="profile.html">Profilim</a>
  </nav>
</header>

<div class="container">
  <div class="back-link">
    <a href="forum.html">&larr; Foruma geri dÃ¶n</a>
  </div>

  <div class="topic-header" id="topicHeader">
    <div class="topic-title" id="topicTitle">Konu yÃ¼kleniyor...</div>
    <div class="topic-meta" id="topicMeta"></div>
    <div class="topic-message" id="topicMessage"></div>
  </div>

  <h2 style="font-size:18px;margin-bottom:10px;color:#c8d2ff;">Yorumlar</h2>
  <div id="messages-list">
    <!-- Yorum kartlarÄ± buraya gelecek -->
  </div>

  <div class="reply-box">
    <div class="reply-title">Yorum Yaz</div>

    <div class="input-row">
      <input type="text" id="nickname" placeholder="Takma adÄ±n (Ã¶r: Nebride)">
    </div>

    <textarea id="message" placeholder="Yorumunu yaz..."></textarea>

    <button class="reply-button" id="replyBtn">Yorumu GÃ¶nder</button>

    <div class="info-text">
      Yorumlar anonimdir ve Firebase Firestoreâ€™da saklanÄ±r. LÃ¼tfen kiÅŸisel bilgilerini paylaÅŸma.
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    doc,
    updateDoc,
    increment,
    serverTimestamp,
    query,
    orderBy,
    onSnapshot,
    getDoc
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBAwFSe0pud59OXpx1G5hQO9opA1f7Eg9Y",
    authDomain: "nebchat2.firebaseapp.com",
    projectId: "nebchat2",
    storageBucket: "nebchat2.firebasestorage.app",
    messagingSenderId: "46979426016",
    appId: "1:46979426016:web:fd1fbe341fff6970ae9285"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const params = new URLSearchParams(window.location.search);
  const postId = params.get("id");

  const topicTitleEl = document.getElementById("topicTitle");
  const topicMetaEl = document.getElementById("topicMeta");
  const topicMessageEl = document.getElementById("topicMessage");
  const messagesListEl = document.getElementById("messages-list");
  const nicknameInput = document.getElementById("nickname");
  const messageInput = document.getElementById("message");
  const replyBtn = document.getElementById("replyBtn");

  if (!postId) {
    topicTitleEl.textContent = "Konu bulunamadÄ±";
    topicMetaEl.textContent = "GeÃ§ersiz baÄŸlantÄ±.";
  } else {
    loadTopic(postId);
    listenReplies(postId);
  }

  // ðŸ”¹ Konu detayÄ±nÄ± yÃ¼kle
  async function loadTopic(id) {
    try {
      const ref = doc(db, "posts", id);
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        topicTitleEl.textContent = "Konu bulunamadÄ±";
        topicMetaEl.textContent = "";
        topicMessageEl.textContent = "";
        return;
      }

      const data = snap.data();
      topicTitleEl.textContent = data.title || "BaÅŸlÄ±ksÄ±z Konu";

      let timeText = "";
      if (data.createdAt && data.createdAt.toDate) {
        const d = data.createdAt.toDate();
        timeText = d.toLocaleString("tr-TR", {
          day: "2-digit",
          month: "2-digit",
          hour: "2-digit",
          minute: "2-digit"
        });
      }

      topicMetaEl.textContent = `AÃ§an: ${data.nick || "Anonim"} â€¢ ${timeText || ""}`;
      topicMessageEl.textContent = data.message || "";
    } catch (e) {
      console.error("Konu yÃ¼klenirken hata:", e);
      topicTitleEl.textContent = "Konu yÃ¼klenirken hata oluÅŸtu";
    }
  }

  // ðŸ”¹ YorumlarÄ± canlÄ± dinle
  function listenReplies(id) {
    const repliesRef = collection(db, "posts", id, "replies");
    const q = query(repliesRef, orderBy("createdAt", "asc"));

    onSnapshot(q, (snapshot) => {
      messagesListEl.innerHTML = "";

      if (snapshot.empty) {
        const p = document.createElement("p");
        p.className = "no-comment";
        p.textContent = "HenÃ¼z yorum yok. Ä°lk yorumu sen yaz ðŸ˜Š";
        messagesListEl.appendChild(p);
        return;
      }

      snapshot.forEach((docSnap) => {
        const data = docSnap.data();

        const card = document.createElement("div");
        card.className = "message-card";

        const userRow = document.createElement("div");
        userRow.className = "msg-user";

        const avatar = document.createElement("div");
        avatar.className = "msg-avatar";
        avatar.textContent = (data.nick || "?").charAt(0).toUpperCase();

        const nameBlock = document.createElement("div");
        const name = document.createElement("div");
        name.className = "msg-username";
        name.textContent = data.nick || "Anonim";

        const time = document.createElement("div");
        time.className = "msg-time";

        let t = "";
        if (data.createdAt && data.createdAt.toDate) {
          const d = data.createdAt.toDate();
          t = d.toLocaleString("tr-TR", {
            day: "2-digit",
            month: "2-digit",
            hour: "2-digit",
            minute: "2-digit"
          });
        }
        time.textContent = t || "";

        nameBlock.appendChild(name);
        nameBlock.appendChild(time);

        userRow.appendChild(avatar);
        userRow.appendChild(nameBlock);

        const text = document.createElement("div");
        text.className = "msg-text";
        text.textContent = data.message || "";

        card.appendChild(userRow);
        card.appendChild(text);

        messagesListEl.appendChild(card);
      });
    });
  }

  // ðŸ”¹ Yorum gÃ¶nder + replyCount ve lastReplyAt gÃ¼ncelle
  replyBtn.addEventListener("click", async () => {
    if (!postId) {
      alert("GeÃ§ersiz konu.");
      return;
    }

    const nick = nicknameInput.value.trim();
    const text = messageInput.value.trim();

    if (!nick || !text) {
      alert("LÃ¼tfen hem nick hem de yorumu doldur.");
      return;
    }

    try {
      // 1) replies alt koleksiyonuna yorum ekle
      const repliesRef = collection(db, "posts", postId, "replies");
      await addDoc(repliesRef, {
        nick,
        message: text,
        createdAt: serverTimestamp()
      });

      // 2) Ana post dokÃ¼manÄ±nda replyCount +1 ve lastReplyAt gÃ¼ncelle
      const postRef = doc(db, "posts", postId);
      await updateDoc(postRef, {
        replyCount: increment(1),
        lastReplyAt: serverTimestamp()
      });

      // 3) mesaj kutusunu temizle
      messageInput.value = "";
    } catch (e) {
      console.error("Yorum eklenirken hata:", e);
      alert("Yorum eklenirken bir hata oluÅŸtu.");
    }
  });
</script>


</body>
</html>
