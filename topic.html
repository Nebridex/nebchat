<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NebChat ‚Ä¢ Konu Detayƒ±</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Pacifico&display=swap');

    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background: #080d1a;
      color: #e0e4ff;
    }

    header {
      background: rgba(15, 20, 40, 0.9);
      padding: 18px 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(80, 100, 255, 0.25);
      box-shadow: 0 0 18px rgba(0, 162, 255, 0.25);
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
    }

    .logo-title {
      font-family: 'Pacifico', cursive;
      font-size: 28px;
      color: #8ab4ff;
      text-shadow: 0 0 10px rgba(121, 169, 255, 0.9);
    }

    .menu {
      display: flex;
      gap: 16px;
    }

    .menu a {
      color: #a8b4ff;
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(108, 99, 255, 0.3);
      background: rgba(255, 255, 255, 0.03);
      transition: 0.25s;
    }

    .menu a:hover {
      background: rgba(108, 99, 255, 0.25);
      box-shadow: 0 0 14px rgba(108, 99, 255, 0.5);
      color: #ffffff;
    }

    main.page {
      max-width: 900px;
      margin: 30px auto 60px;
      padding: 0 16px;
    }

    .topic-box {
      background: rgba(14, 18, 40, 0.98);
      border-radius: 20px;
      padding: 18px 16px;
      border: 1px solid rgba(108, 99, 255, 0.5);
      box-shadow: 0 0 26px rgba(80, 70, 230, 0.55);
      margin-bottom: 24px;
    }

    .topic-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #dfe4ff;
    }

    .topic-meta {
      font-size: 12px;
      color: #a3aedf;
      margin-bottom: 10px;
    }

    .badge-registered {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(108, 99, 255, 0.2);
      border: 1px solid rgba(108, 99, 255, 0.7);
      margin-left: 4px;
    }

    .badge-guest {
      font-size: 10px;
      opacity: 0.7;
      margin-left: 4px;
    }

    .topic-message {
      font-size: 14px;
      line-height: 1.6;
      color: #e4e8ff;
    }

    .topic-message pre {
      padding: 10px;
      border-radius: 8px;
      background: #111827;
      overflow-x: auto;
      font-size: 13px;
    }

    .topic-message code {
      font-family: "Fira Code", monospace;
      font-size: 13px;
    }

    .like-row {
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn-like {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255, 215, 140, 0.8);
      background: rgba(255, 215, 140, 0.1);
      color: #ffd78c;
      font-size: 13px;
      cursor: pointer;
      transition: 0.2s;
    }

    .btn-like:hover {
      background: rgba(255, 215, 140, 0.2);
      box-shadow: 0 0 14px rgba(255, 215, 140, 0.6);
    }

    .btn-dislike {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255, 144, 144, 0.75);
      background: rgba(255, 96, 96, 0.12);
      color: #ffb4b4;
      font-size: 13px;
      cursor: pointer;
      transition: 0.2s;
    }

    .btn-dislike:hover {
      background: rgba(255, 96, 96, 0.2);
      box-shadow: 0 0 14px rgba(255, 96, 96, 0.55);
    }

    .btn-like.active {
      background: rgba(255, 215, 140, 0.28);
      box-shadow: 0 0 15px rgba(255, 215, 140, 0.7);
    }

    .btn-dislike.active {
      background: rgba(255, 96, 96, 0.28);
      box-shadow: 0 0 15px rgba(255, 96, 96, 0.65);
    }

    .msg-actions button.active {
      border-color: rgba(138, 127, 255, 0.9);
      box-shadow: 0 0 14px rgba(138, 127, 255, 0.6);
      background: rgba(108, 99, 255, 0.35);
    }

    .score-pill {
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid rgba(130, 147, 255, 0.45);
      background: rgba(95, 112, 255, 0.15);
      color: #dbe3ff;
      padding: 5px 9px;
      font-weight: 600;
    }

    .reply-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .reply-toolbar select {
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(108, 99, 255, 0.45);
      background: rgba(9, 14, 34, 0.9);
      color: #dfe6ff;
      font-size: 12px;
      outline: none;
    }

    .messages-box {
      background: rgba(10, 14, 32, 0.98);
      border-radius: 18px;
      padding: 14px 12px;
      border: 1px solid rgba(108, 99, 255, 0.35);
      box-shadow: 0 0 22px rgba(80, 70, 230, 0.45);
      margin-bottom: 22px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #cdd7ff;
    }

    .msg-item {
      display: flex;
      gap: 10px;
      padding: 10px 6px;
      border-radius: 12px;
      border: 1px solid rgba(70, 70, 150, 0.5);
      background: rgba(16, 22, 55, 0.95);
      margin-bottom: 8px;
      position: relative;
    }

    .msg-item.solution {
      border-color: rgba(72, 187, 120, 0.9);
      box-shadow: 0 0 20px rgba(72, 187, 120, 0.7);
      background: linear-gradient(135deg, rgba(16,22,55,0.95), rgba(30,64,45,0.9));
    }

    .solution-badge {
      position: absolute;
      top: 6px;
      right: 8px;
      background: rgba(72, 187, 120, 0.2);
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 11px;
      color: #9ae6b4;
      border: 1px solid rgba(72, 187, 120, 0.7);
    }

    .msg-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #6d6cff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      color: white;
      box-shadow: 0 0 18px rgba(120, 140, 255, 0.9);
      flex-shrink: 0;
    }

    .msg-body {
      flex: 1;
    }

    .msg-username {
      font-size: 13px;
      font-weight: 600;
      color: #cdd7ff;
    }

    .msg-time {
      font-size: 11px;
      color: #9ea8e0;
      opacity: 0.9;
    }

    .msg-text {
      font-size: 14px;
      line-height: 1.5;
      margin-top: 4px;
      color: #e4e8ff;
    }

    .msg-text pre {
      padding: 8px;
      border-radius: 8px;
      background: #111827;
      overflow-x: auto;
      font-size: 13px;
    }

    .msg-text code {
      font-family: "Fira Code", monospace;
      font-size: 13px;
    }

    .msg-actions {
      margin-top: 6px;
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 11px;
      color: #a3aedf;
    }

    .msg-actions button {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(108, 99, 255, 0.5);
      background: rgba(108, 99, 255, 0.15);
      color: #e0e4ff;
      cursor: pointer;
      font-size: 11px;
      transition: 0.2s;
    }

    .msg-actions button:hover {
      background: rgba(108, 99, 255, 0.3);
    }

    .reply-box {
      background: rgba(14, 18, 40, 0.98);
      border-radius: 18px;
      padding: 16px 14px;
      border: 1px solid rgba(108, 99, 255, 0.45);
      box-shadow: 0 0 24px rgba(80, 70, 230, 0.55);
    }

    .form-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .form-row input {
      flex: 1;
      min-width: 160px;
      padding: 9px;
      border-radius: 10px;
      border: 1px solid rgba(108, 99, 255, 0.4);
      background: rgba(7, 12, 30, 0.9);
      color: #ffffff;
      font-size: 13px;
      outline: none;
    }

    textarea {
      width: 100%;
      min-height: 80px;
      border-radius: 12px;
      border: 1px solid rgba(108, 99, 255, 0.35);
      background: rgba(7, 12, 30, 0.95);
      padding: 10px;
      color: white;
      font-size: 14px;
      resize: vertical;
      margin-bottom: 8px;
    }

    .btn-main {
      padding: 9px 18px;
      border-radius: 10px;
      border: 1px solid rgba(108, 99, 255, 0.7);
      background: rgba(108, 99, 255, 0.7);
      color: #e0e4ff;
      font-size: 14px;
      cursor: pointer;
      transition: 0.25s;
    }

    .btn-main:hover {
      background: rgba(108, 99, 255, 0.9);
      box-shadow: 0 0 20px rgba(108, 99, 255, 0.85);
    }

    .info-text {
      margin-top: 8px;
      font-size: 11px;
      color: #9ca6e0;
    }

    .login-indicator {
      font-size: 11px;
      color: #cdd6ff;
      margin-top: 4px;
      opacity: 0.85;
    }

    footer {
      margin-top: 40px;
      padding: 20px;
      text-align: center;
      font-size: 13px;
      color: #8189c4;
    }
  </style>
</head>

<body>
<header>
  <a href="index.html" style="text-decoration:none;">
    <div class="logo-title">NebChat</div>
  </a>
  <nav class="menu">
    <a href="index.html">Ana Sayfa</a>
    <a href="forum.html">Forum</a>
    <a href="profile.html">Profilim</a>
  </nav>
</header>

<main class="page">
  <section class="topic-box">
    <div class="topic-title" id="topicTitle">Konu y√ºkleniyor...</div>
    <div class="topic-meta" id="topicMeta"></div>
    <div class="topic-message" id="topicMessage"></div>

    <div class="like-row">
      <button class="btn-like" id="likeBtn">üëç Beƒüen (<span id="likeCount">0</span>)</button>
      <button class="btn-dislike" id="dislikeBtn">üëé Katƒ±lmƒ±yorum (<span id="dislikeCount">0</span>)</button>
      <span class="score-pill" id="topicScorePill">Skor: 0</span>
      <span style="font-size:11px;color:#9ea8e0;">
        Oylama dengesiyle kaliteli yanƒ±tlarƒ± √∂ne √ßƒ±kar. Beƒüeniler konu sahibine profil puanƒ± olarak yansƒ±r.
      </span>
    </div>
  </section>

  <section class="messages-box">
    <div class="reply-toolbar">
      <div class="section-title" style="margin-bottom:0;">Yanƒ±tlar</div>
      <select id="replySortSelect">
        <option value="top">En faydalƒ± (skor)</option>
        <option value="newest">En yeni</option>
        <option value="oldest">En eski</option>
        <option value="controversial">En tartƒ±≈ümalƒ±</option>
      </select>
    </div>
    <div id="messages-list"></div>
  </section>

  <section class="reply-box">
    <div class="section-title">Cevap Yaz</div>
    <div class="form-row">
      <input type="text" id="nickname" placeholder="Takma adƒ±n (guest i√ßin)" minlength="2" maxlength="24" autocomplete="nickname">
    </div>
    <textarea id="message" placeholder="Mesajƒ±nƒ± yaz... (Markdown destekli)" minlength="12" maxlength="4000"></textarea>
    <button class="btn-main" id="replyBtn">G√∂nder</button>
    <div class="info-text">
      Markdown destekli. Kod i√ßin ``` bloklarƒ± kullanabilirsin.
      <div class="login-indicator" id="replyLoginInfo">
        Giri≈ü yaparsan yazdƒ±ƒüƒ±n mesajlar kayƒ±tlƒ± kullanƒ±cƒ± adƒ±nla g√∂r√ºn√ºr, guest‚Äôler kayƒ±tlƒ± nick kullanamaz.
      </div>
    </div>
  </section>
</main>

<footer>
  NebChat anonim forum ‚Ä¢ Konu detay sayfasƒ±.
</footer>

<script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.6/dist/purify.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    doc,
    updateDoc,
    increment,
    serverTimestamp,
    query,
    orderBy,
    onSnapshot,
    getDoc,
    getDocs,
    where
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBAwFSe0pud59OXpx1G5hQO9opA1f7Eg9Y",
    authDomain: "nebchat2.firebaseapp.com",
    projectId: "nebchat2",
    storageBucket: "nebchat2.firebasestorage.app",
    messagingSenderId: "46979426016",
    appId: "1:46979426016:web:fd1fbe341fff6970ae9285"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const categoryMap = {
    cyber: "üõ° Cyber Security",
    network: "üåê Network & Infrastructure",
    cloud: "‚òÅÔ∏è Cloud & DevOps",
    career: "üíº Career & Salary",
    products: "üì¶ Products & Vendors",
    anon: "üôà Anon Confessions",
    tech: "üí° Tech Discussions",
    community: "üé≠ Off-Topic / Community",
    blue: "Blue Team / SOC",
    red: "Red Team / OffSec",
    bug: "Bug Bounty",
    genel: "Genel Sohbet"
  };

  const params = new URLSearchParams(window.location.search);
  const postId = params.get("id");

  const topicTitleEl = document.getElementById("topicTitle");
  const topicMetaEl = document.getElementById("topicMeta");
  const topicMessageEl = document.getElementById("topicMessage");
  const messagesListEl = document.getElementById("messages-list");
  const nicknameInput = document.getElementById("nickname");
  const messageInput = document.getElementById("message");
  const replyBtn = document.getElementById("replyBtn");
  const likeBtn = document.getElementById("likeBtn");
  const dislikeBtn = document.getElementById("dislikeBtn");
  const likeCountEl = document.getElementById("likeCount");
  const dislikeCountEl = document.getElementById("dislikeCount");
  const topicScorePill = document.getElementById("topicScorePill");
  const replySortSelect = document.getElementById("replySortSelect");
  const replyLoginInfo = document.getElementById("replyLoginInfo");

  const LIMITS = {
    nickMin: 2,
    nickMax: 24,
    messageMin: 12,
    messageMax: 4000
  };

  const converter = new showdown.Converter({
    simpleLineBreaks: true,
    strikethrough: true,
    tables: true,
    ghCodeBlocks: true
  });

  function renderMarkdown(element, text) {
    const source = text || "";
    const html = converter.makeHtml(source);

    if (window.DOMPurify) {
      const safeHtml = window.DOMPurify.sanitize(html, {
        USE_PROFILES: { html: true },
        ALLOWED_URI_REGEXP: /^(?:(?:https?|mailto|tel):|[^a-z]|[a-z+.-]+(?:[^a-z+.-:]|$))/i
      });
      element.innerHTML = safeHtml;
    } else {
      // DOMPurify y√ºklenemezse, g√ºvenlik i√ßin markdown √ßƒ±ktƒ±sƒ± yerine d√ºz metin g√∂ster.
      element.textContent = source;
    }

    if (window.hljs) {
      element.querySelectorAll("pre code").forEach((codeBlock) => {
        window.hljs.highlightElement(codeBlock);
      });
    }
  }

  function createUserBadge(isRegistered) {
    const badge = document.createElement("span");
    badge.className = isRegistered ? "badge-registered" : "badge-guest";
    badge.textContent = isRegistered ? "registered" : "guest";
    return badge;
  }

  let currentUser = null;
  let currentUserProfile = null;
  let loadedPost = null;
  let latestReplies = [];

  const voteStorageKey = `nebchat-votes:${postId || "unknown"}`;
  let localVotes = {};

  try {
    localVotes = JSON.parse(localStorage.getItem(voteStorageKey) || "{}") || {};
  } catch {
    localVotes = {};
  }

  function getLocalVote(targetId) {
    return localVotes[targetId] || null;
  }

  function setLocalVote(targetId, vote) {
    if (!vote) delete localVotes[targetId];
    else localVotes[targetId] = vote;
    localStorage.setItem(voteStorageKey, JSON.stringify(localVotes));
  }

  function applyTopicVoteVisual() {
    const vote = getLocalVote(`post:${postId}`);
    likeBtn.classList.toggle("active", vote === "like");
    dislikeBtn.classList.toggle("active", vote === "dislike");
  }

  async function loadUserProfile(uid) {
    try {
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) return null;
      return snap.data();
    } catch (e) {
      console.error("Kullanƒ±cƒ± profili alƒ±namadƒ±:", e);
      return null;
    }
  }

  function validateGuestNick(nick) {
    if (!nick) return false;
    const value = nick.trim();
    if (value.length < LIMITS.nickMin || value.length > LIMITS.nickMax) return false;
    if (!/^[\p{L}\p{N}_.-]+$/u.test(value)) return false;
    return true;
  }

  async function isNickReserved(nick) {
    const lower = nick.trim().toLowerCase();
    if (!lower) return false;
    const q = query(collection(db, "users"), where("usernameLower", "==", lower));
    const snap = await getDocs(q);
    return !snap.empty;
  }

  onAuthStateChanged(auth, async (user) => {
    currentUser = user || null;
    currentUserProfile = null;

    if (!user) {
      replyLoginInfo.textContent =
        "Giri≈ü yaparsan yazdƒ±ƒüƒ±n mesajlar kayƒ±tlƒ± kullanƒ±cƒ± adƒ±nla g√∂r√ºn√ºr. Guest‚Äôler kayƒ±tlƒ± nick kullanamaz.";
      nicknameInput.disabled = false;
      nicknameInput.placeholder = "Takma adƒ±n (guest i√ßin)";
      return;
    }

    const profile = await loadUserProfile(user.uid);
    currentUserProfile = profile;

    const username =
      profile?.username ||
      (user.email ? user.email.split("@")[0] : "Kayƒ±tlƒ± Kullanƒ±cƒ±");
    replyLoginInfo.textContent =
      `Giri≈ü yaptƒ±n: ${username}. Bu konuda yazdƒ±ƒüƒ±n t√ºm cevaplar bu kullanƒ±cƒ± adƒ± ile g√∂r√ºnecek.`;
    nicknameInput.value = "";
    nicknameInput.disabled = true;
    nicknameInput.placeholder = `${username} (kayƒ±tlƒ± kullanƒ±cƒ±)`;
  });

  if (!postId) {
    topicTitleEl.textContent = "Konu bulunamadƒ±";
    topicMetaEl.textContent = "";
    topicMessageEl.textContent = "";
    likeBtn.disabled = true;
    dislikeBtn.disabled = true;
  } else {
    loadPost();
    listenReplies();
  }

  async function loadPost() {
    try {
      const ref = doc(db, "posts", postId);
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        topicTitleEl.textContent = "Konu bulunamadƒ±";
        topicMetaEl.textContent = "";
        topicMessageEl.textContent = "";
        likeBtn.disabled = true;
        dislikeBtn.disabled = true;
        return;
      }

      const data = snap.data();
      loadedPost = { id: snap.id, ...data };

      const categoryText = categoryMap[data.category] || "Kategori";

      let timeText = "";
      if (data.createdAt?.toDate) {
        const d = data.createdAt.toDate();
        timeText = d.toLocaleString("tr-TR", {
          day: "2-digit",
          month: "2-digit",
          hour: "2-digit",
          minute: "2-digit"
        });
      }

      topicTitleEl.textContent = `${categoryText} ‚Ä¢ ${data.title || "Ba≈ülƒ±ksƒ±z Konu"}`;
      topicMetaEl.textContent = "";
      topicMetaEl.append("A√ßan: " + (data.nick || "Anonim") + " ");
      topicMetaEl.appendChild(createUserBadge(Boolean(data.userId)));
      if (timeText) {
        topicMetaEl.append(" ‚Ä¢ " + timeText);
      }

      renderMarkdown(topicMessageEl, data.message || "");

      const likes = typeof data.likes === "number" ? data.likes : 0;
      const dislikes = typeof data.dislikes === "number" ? data.dislikes : 0;
      likeCountEl.textContent = likes;
      dislikeCountEl.textContent = dislikes;
      topicScorePill.textContent = `Skor: ${likes - dislikes}`;
      applyTopicVoteVisual();
    } catch (e) {
      console.error("Konu y√ºklenirken hata:", e);
      topicTitleEl.textContent = "Konu y√ºklenirken hata olu≈ütu.";
    }
  }

  function getReplyScore(reply) {
    const likes = typeof reply.likes === "number" ? reply.likes : 0;
    const dislikes = typeof reply.dislikes === "number" ? reply.dislikes : 0;
    return likes - dislikes;
  }

  function renderReplies() {
    messagesListEl.innerHTML = "";

    if (!latestReplies.length) {
      messagesListEl.innerHTML =
        '<div class="msg-item"><div class="msg-body"><div class="msg-text">Hen√ºz yorum yok. ƒ∞lk yorumu sen yaz.</div></div></div>';
      return;
    }

    let replies = [...latestReplies];
    let solutionReply = null;

    if (loadedPost && loadedPost.solutionReplyId) {
      solutionReply = replies.find((r) => r.id === loadedPost.solutionReplyId) || null;
      replies = replies.filter((r) => r.id !== loadedPost.solutionReplyId);
    }

    const mode = replySortSelect?.value || "top";
    replies.sort((a, b) => {
      const at = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
      const bt = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
      const as = getReplyScore(a);
      const bs = getReplyScore(b);
      const av = (a.likes || 0) + (a.dislikes || 0);
      const bv = (b.likes || 0) + (b.dislikes || 0);

      if (mode === "newest") return bt - at;
      if (mode === "oldest") return at - bt;
      if (mode === "controversial") return bv - av || bt - at;
      return bs - as || bt - at;
    });

    if (solutionReply) {
      messagesListEl.appendChild(createReplyElement(solutionReply, true));
    }

    replies.forEach((data) => {
      messagesListEl.appendChild(createReplyElement(data, false));
    });
  }

  function listenReplies() {
    const repliesRef = collection(db, "posts", postId, "replies");
    const q = query(repliesRef, orderBy("createdAt", "asc"));

    onSnapshot(q, (snapshot) => {
      latestReplies = [];
      snapshot.forEach((docSnap) => {
        latestReplies.push({
          id: docSnap.id,
          ...docSnap.data()
        });
      });
      renderReplies();
    });

    if (replySortSelect) {
      replySortSelect.addEventListener("change", renderReplies);
    }
  }

  function createReplyElement(data, isSolution) {
    const wrapper = document.createElement("div");
    wrapper.className = "msg-item" + (isSolution ? " solution" : "");

    const avatar = document.createElement("div");
    avatar.className = "msg-avatar";
    avatar.textContent = (data.nick || "?").charAt(0).toUpperCase();

    const body = document.createElement("div");
    body.className = "msg-body";

    const nameRow = document.createElement("div");
    const nameEl = document.createElement("span");
    nameEl.className = "msg-username";

    nameEl.textContent = (data.nick || "Anonim") + " ";
    nameEl.appendChild(createUserBadge(Boolean(data.userId)));

    const timeEl = document.createElement("span");
    timeEl.className = "msg-time";

    let t = "";
    if (data.createdAt?.toDate) {
      const d = data.createdAt.toDate();
      t = d.toLocaleString("tr-TR", {
        day: "2-digit",
        month: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
      });
    }
    timeEl.textContent = " ‚Ä¢ " + (t || "");

    nameRow.appendChild(nameEl);
    nameRow.appendChild(timeEl);

    const textEl = document.createElement("div");
    textEl.className = "msg-text";
    renderMarkdown(textEl, data.message || "");

    const actions = document.createElement("div");
    actions.className = "msg-actions";

    const likes = typeof data.likes === "number" ? data.likes : 0;
    const dislikes = typeof data.dislikes === "number" ? data.dislikes : 0;
    const scoreSpan = document.createElement("span");
    scoreSpan.textContent = `Skor ${likes - dislikes} ‚Ä¢ üëç ${likes} / üëé ${dislikes}`;

    const upvoteBtn = document.createElement("button");
    upvoteBtn.textContent = "Beƒüen";

    const downvoteBtn = document.createElement("button");
    downvoteBtn.textContent = "Katƒ±lmƒ±yorum";

    const currentReplyVote = getLocalVote(`reply:${data.id}`);
    upvoteBtn.classList.toggle("active", currentReplyVote === "like");
    downvoteBtn.classList.toggle("active", currentReplyVote === "dislike");

    upvoteBtn.addEventListener("click", () => {
      voteReply(data.id, data.userId || null, "like", scoreSpan, upvoteBtn, downvoteBtn);
    });

    downvoteBtn.addEventListener("click", () => {
      voteReply(data.id, data.userId || null, "dislike", scoreSpan, upvoteBtn, downvoteBtn);
    });

    actions.appendChild(scoreSpan);
    actions.appendChild(upvoteBtn);
    actions.appendChild(downvoteBtn);

    if (loadedPost && currentUser && loadedPost.userId === currentUser.uid) {
      const solutionBtn = document.createElement("button");
      solutionBtn.textContent = isSolution ? "√á√∂z√ºm (se√ßili)" : "√á√∂z√ºm olarak i≈üaretle";
      solutionBtn.addEventListener("click", () => {
        markAsSolution(data.id);
      });
      actions.appendChild(solutionBtn);
    }

    body.appendChild(nameRow);
    body.appendChild(textEl);
    body.appendChild(actions);

    wrapper.appendChild(avatar);
    wrapper.appendChild(body);

    if (isSolution) {
      const badge = document.createElement("div");
      badge.className = "solution-badge";
      badge.textContent = "‚úî √á√ñZ√úM";
      wrapper.appendChild(badge);
    }

    return wrapper;
  }

  replyBtn.addEventListener("click", async () => {
    if (!postId) {
      alert("Ge√ßersiz konu.");
      return;
    }

    let nick;
    const text = messageInput.value.trim();

    if (!text) {
      alert("L√ºtfen yorum alanƒ±nƒ± doldur.");
      return;
    }

    if (text.length < LIMITS.messageMin || text.length > LIMITS.messageMax) {
      alert(`Yorum ${LIMITS.messageMin}-${LIMITS.messageMax} karakter arasƒ±nda olmalƒ±.`);
      return;
    }

    if (currentUser) {
      nick =
        currentUserProfile?.username ||
        (currentUser.email ? currentUser.email.split("@")[0] : "Kayƒ±tlƒ± Kullanƒ±cƒ±");
    } else {
      nick = nicknameInput.value.trim();
      if (!validateGuestNick(nick)) {
        alert(`Ge√ßerli bir takma ad gir (${LIMITS.nickMin}-${LIMITS.nickMax} karakter, sadece harf/rakam (T√ºrk√ße dahil)/_/./-).`);
        return;
      }
      if (await isNickReserved(nick)) {
        alert("Bu nick kayƒ±tlƒ± bir kullanƒ±cƒ±ya ait. Farklƒ± bir takma ad kullan.");
        return;
      }
    }

    try {
      replyBtn.disabled = true;
      const repliesRef = collection(db, "posts", postId, "replies");
      await addDoc(repliesRef, {
        nick,
        message: text,
        createdAt: serverTimestamp(),
        userId: currentUser ? currentUser.uid : null,
        likes: 0,
        dislikes: 0
      });

      const postRef = doc(db, "posts", postId);
      await updateDoc(postRef, {
        replyCount: increment(1),
        lastReplyAt: serverTimestamp()
      });

      if (currentUser) {
        const userRef = doc(db, "users", currentUser.uid);
        updateDoc(userRef, {
          "stats.messages": increment(1)
        }).catch((e) => console.warn("Mesaj istatistiƒüi g√ºncellenemedi:", e));
      }

      messageInput.value = "";
    } catch (e) {
      console.error("Yorum eklenirken hata:", e);
      alert("Yorum eklenirken bir hata olu≈ütu.");
    } finally {
      replyBtn.disabled = false;
    }
  });

  async function voteTopic(action) {
    if (!postId || !loadedPost) {
      alert("Ge√ßersiz konu.");
      return;
    }

    const targetId = `post:${postId}`;
    const currentVote = getLocalVote(targetId);

    let likeDelta = 0;
    let dislikeDelta = 0;
    let nextVote = action;

    if (currentVote === action) {
      nextVote = null;
      if (action === "like") likeDelta = -1;
      if (action === "dislike") dislikeDelta = -1;
    } else if (!currentVote) {
      if (action === "like") likeDelta = 1;
      if (action === "dislike") dislikeDelta = 1;
    } else {
      if (action === "like") {
        likeDelta = 1;
        dislikeDelta = -1;
      } else {
        likeDelta = -1;
        dislikeDelta = 1;
      }
    }

    try {
      likeBtn.disabled = true;
      dislikeBtn.disabled = true;

      const postRef = doc(db, "posts", postId);
      const payload = {};
      if (likeDelta) payload.likes = increment(likeDelta);
      if (dislikeDelta) payload.dislikes = increment(dislikeDelta);
      await updateDoc(postRef, payload);

      const likes = parseInt(likeCountEl.textContent || "0", 10) + likeDelta;
      const dislikes = parseInt(dislikeCountEl.textContent || "0", 10) + dislikeDelta;
      likeCountEl.textContent = Math.max(likes, 0);
      dislikeCountEl.textContent = Math.max(dislikes, 0);
      topicScorePill.textContent = `Skor: ${Math.max(likes, 0) - Math.max(dislikes, 0)}`;

      if (likeDelta > 0 && loadedPost.userId) {
        const ownerRef = doc(db, "users", loadedPost.userId);
        updateDoc(ownerRef, {
          "stats.likes": increment(1)
        }).catch((e) => console.warn("Konu sahibi like istatistiƒüi g√ºncellenemedi:", e));
      }

      setLocalVote(targetId, nextVote);
      applyTopicVoteVisual();
    } catch (e) {
      console.error("Konu oylanƒ±rken hata:", e);
      alert("Oylama sƒ±rasƒ±nda bir hata olu≈ütu.");
    } finally {
      likeBtn.disabled = false;
      dislikeBtn.disabled = false;
    }
  }

  likeBtn.addEventListener("click", async () => {
    voteTopic("like");
  });

  dislikeBtn.addEventListener("click", async () => {
    voteTopic("dislike");
  });

  async function voteReply(replyId, replyUserId, action, scoreElement, upvoteBtn, downvoteBtn) {
    if (!postId || !replyId) {
      alert("Ge√ßersiz yorum.");
      return;
    }

    const targetId = `reply:${replyId}`;
    const currentVote = getLocalVote(targetId);

    let likeDelta = 0;
    let dislikeDelta = 0;
    let nextVote = action;

    if (currentVote === action) {
      nextVote = null;
      if (action === "like") likeDelta = -1;
      if (action === "dislike") dislikeDelta = -1;
    } else if (!currentVote) {
      if (action === "like") likeDelta = 1;
      if (action === "dislike") dislikeDelta = 1;
    } else {
      if (action === "like") {
        likeDelta = 1;
        dislikeDelta = -1;
      } else {
        likeDelta = -1;
        dislikeDelta = 1;
      }
    }

    try {
      upvoteBtn.disabled = true;
      downvoteBtn.disabled = true;

      const replyRef = doc(db, "posts", postId, "replies", replyId);
      const payload = {};
      if (likeDelta) payload.likes = increment(likeDelta);
      if (dislikeDelta) payload.dislikes = increment(dislikeDelta);
      await updateDoc(replyRef, payload);

      const text = scoreElement.textContent || "";
      const m = text.match(/Skor\s(-?\d+)\s‚Ä¢\süëç\s(\d+)\s\/\süëé\s(\d+)/);
      let score = m ? parseInt(m[1], 10) : 0;
      let likes = m ? parseInt(m[2], 10) : 0;
      let dislikes = m ? parseInt(m[3], 10) : 0;
      likes = Math.max(likes + likeDelta, 0);
      dislikes = Math.max(dislikes + dislikeDelta, 0);
      score = likes - dislikes;
      scoreElement.textContent = `Skor ${score} ‚Ä¢ üëç ${likes} / üëé ${dislikes}`;

      if (likeDelta > 0 && replyUserId) {
        const userRef = doc(db, "users", replyUserId);
        updateDoc(userRef, {
          "stats.likes": increment(1)
        }).catch((e) => console.warn("Yorum sahibi like istatistiƒüi g√ºncellenemedi:", e));
      }

      setLocalVote(targetId, nextVote);
      upvoteBtn.classList.toggle("active", nextVote === "like");
      downvoteBtn.classList.toggle("active", nextVote === "dislike");
    } catch (e) {
      console.error("Reply oylanƒ±rken hata:", e);
      alert("Oylama sƒ±rasƒ±nda bir hata olu≈ütu.");
    } finally {
      upvoteBtn.disabled = false;
      downvoteBtn.disabled = false;
    }
  }

  async function markAsSolution(replyId) {
    if (!postId || !loadedPost) return;

    if (!currentUser || loadedPost.userId !== currentUser.uid) {
      alert("Sadece konuyu a√ßan ki≈üi √ß√∂z√ºm√º i≈üaretleyebilir.");
      return;
    }

    try {
      const postRef = doc(db, "posts", postId);
      await updateDoc(postRef, {
        solutionReplyId: replyId
      });
      loadedPost.solutionReplyId = replyId;
    } catch (e) {
      console.error("√á√∂z√ºm i≈üaretlenirken hata:", e);
      alert("√á√∂z√ºm i≈üaretlenirken bir hata olu≈ütu.");
    }
  }
</script>

</body>
</html>
