<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NebChat ‚Ä¢ Konu Detayƒ±</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Pacifico&display=swap');

    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background: #080d1a;
      color: #e0e4ff;
    }

    header {
      background: rgba(15, 20, 40, 0.9);
      padding: 18px 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(80, 100, 255, 0.25);
      box-shadow: 0 0 18px rgba(0, 162, 255, 0.25);
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
    }

    .logo-area {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .logo-title {
      font-family: 'Pacifico', cursive;
      font-size: 28px;
      color: #8ab4ff;
      text-shadow: 0 0 10px rgba(121, 169, 255, 0.9);
    }

    .menu {
      display: flex;
      gap: 16px;
    }

    .menu a {
      color: #a8b4ff;
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(108, 99, 255, 0.3);
      background: rgba(255, 255, 255, 0.03);
      transition: 0.25s;
    }

    .menu a:hover {
      background: rgba(108, 99, 255, 0.25);
      box-shadow: 0 0 14px rgba(108, 99, 255, 0.5);
      color: #ffffff;
    }

    main.page {
      max-width: 900px;
      margin: 30px auto 60px;
      padding: 0 16px;
    }

    .topic-box {
      background: rgba(14, 18, 40, 0.98);
      border-radius: 20px;
      padding: 18px 16px;
      border: 1px solid rgba(108, 99, 255, 0.5);
      box-shadow: 0 0 26px rgba(80, 70, 230, 0.55);
      margin-bottom: 24px;
    }

    .topic-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #dfe4ff;
    }

    .topic-meta {
      font-size: 12px;
      color: #a3aedf;
      margin-bottom: 10px;
    }

    .topic-message {
      font-size: 14px;
      line-height: 1.6;
      color: #e4e8ff;
    }

    .like-row {
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn-like {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255, 215, 140, 0.8);
      background: rgba(255, 215, 140, 0.1);
      color: #ffd78c;
      font-size: 13px;
      cursor: pointer;
      transition: 0.2s;
    }

    .btn-like:hover {
      background: rgba(255, 215, 140, 0.2);
      box-shadow: 0 0 14px rgba(255, 215, 140, 0.6);
    }

    .like-info {
      font-size: 11px;
      color: #9ea8e0;
      opacity: 0.9;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #cdd7ff;
    }

    .messages-box {
      background: rgba(10, 14, 32, 0.98);
      border-radius: 18px;
      padding: 14px 12px;
      border: 1px solid rgba(108, 99, 255, 0.35);
      box-shadow: 0 0 22px rgba(80, 70, 230, 0.45);
      margin-bottom: 22px;
    }

    .msg-item {
      display: flex;
      gap: 10px;
      padding: 10px 6px;
      border-radius: 12px;
      border: 1px solid rgba(70, 70, 150, 0.5);
      background: rgba(16, 22, 55, 0.95);
      margin-bottom: 8px;
    }

    .msg-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #6d6cff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      color: white;
      box-shadow: 0 0 18px rgba(120, 140, 255, 0.9);
      flex-shrink: 0;
    }

    .msg-body {
      flex: 1;
    }

    .msg-username {
      font-size: 13px;
      font-weight: 600;
      color: #cdd7ff;
    }

    .msg-time {
      font-size: 11px;
      color: #9ea8e0;
      opacity: 0.9;
    }

    .msg-text {
      font-size: 14px;
      line-height: 1.5;
      margin-top: 4px;
      color: #e4e8ff;
    }

    .reply-box {
      background: rgba(14, 18, 40, 0.98);
      border-radius: 18px;
      padding: 16px 14px;
      border: 1px solid rgba(108, 99, 255, 0.45);
      box-shadow: 0 0 24px rgba(80, 70, 230, 0.55);
    }

    .form-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .form-row input {
      flex: 1;
      min-width: 160px;
      padding: 9px;
      border-radius: 10px;
      border: 1px solid rgba(108, 99, 255, 0.4);
      background: rgba(7, 12, 30, 0.9);
      color: #ffffff;
      font-size: 13px;
      outline: none;
    }

    textarea {
      width: 100%;
      min-height: 80px;
      border-radius: 12px;
      border: 1px solid rgba(108, 99, 255, 0.35);
      background: rgba(7, 12, 30, 0.95);
      padding: 10px;
      color: white;
      font-size: 14px;
      resize: vertical;
      margin-bottom: 8px;
    }

    .btn-main {
      padding: 9px 18px;
      border-radius: 10px;
      border: 1px solid rgba(108, 99, 255, 0.7);
      background: rgba(108, 99, 255, 0.7);
      color: #e0e4ff;
      font-size: 14px;
      cursor: pointer;
      transition: 0.25s;
    }

    .btn-main:hover {
      background: rgba(108, 99, 255, 0.9);
      box-shadow: 0 0 20px rgba(108, 99, 255, 0.85);
    }

    .info-text {
      margin-top: 8px;
      font-size: 11px;
      color: #9ca6e0;
    }

    footer {
      margin-top: 40px;
      padding: 20px;
      text-align: center;
      font-size: 13px;
      color: #8189c4;
    }

    .login-indicator {
      font-size: 11px;
      color: #cdd6ff;
      margin-top: 4px;
      opacity: 0.85;
    }
  </style>
</head>

<body>
<header>
  <div class="logo-area">
    <a href="index.html" style="text-decoration:none;">
      <div class="logo-title">NebChat</div>
    </a>
  </div>

  <nav class="menu">
    <a href="index.html">Ana Sayfa</a>
    <a href="forum.html">Forum</a>
    <a href="profile.html">Profilim</a>
  </nav>
</header>

<main class="page">
  <section class="topic-box">
    <div class="topic-title" id="topicTitle">Konu y√ºkleniyor...</div>
    <div class="topic-meta" id="topicMeta"></div>
    <div class="topic-message" id="topicMessage"></div>

    <div class="like-row">
      <button class="btn-like" id="likeBtn">üëç Beƒüen (<span id="likeCount">0</span>)</button>
      <div class="like-info">
        Beƒüeniler, konu sahibini destekler. Giri≈ü yaparsan aldƒ±ƒüƒ±n beƒüeniler profilinde g√∂r√ºn√ºr.
      </div>
    </div>
  </section>

  <section class="messages-box">
    <div class="section-title">Yanƒ±tlar</div>
    <div id="messages-list"></div>
  </section>

  <section class="reply-box">
    <div class="section-title">Cevap Yaz</div>
    <div class="form-row">
      <input type="text" id="nickname" placeholder="Takma adƒ±n (√∂r: Nebride)">
    </div>
    <textarea id="message" placeholder="Mesajƒ±nƒ± yaz..."></textarea>
    <button class="btn-main" id="replyBtn">G√∂nder</button>
    <div class="info-text">
      Yorumlar anonimdir ve Firebase Firestore‚Äôda saklanƒ±r. L√ºtfen ki≈üisel bilgi yazma.
      <div class="login-indicator" id="replyLoginInfo">
        Giri≈ü yaparsan yazdƒ±ƒüƒ±n mesajlar profilinde sayƒ±lƒ±r. (Profilim ‚Üí Giri≈ü)
      </div>
    </div>
  </section>
</main>

<footer>
  NebChat anonim forum ‚Ä¢ ƒ∞√ßerik kullanƒ±cƒ±larƒ±n sorumluluƒüundadƒ±r.
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    doc,
    updateDoc,
    increment,
    serverTimestamp,
    query,
    orderBy,
    onSnapshot,
    getDoc
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBAwFSe0pud59OXpx1G5hQO9opA1f7Eg9Y",
    authDomain: "nebchat2.firebaseapp.com",
    projectId: "nebchat2",
    storageBucket: "nebchat2.firebasestorage.app",
    messagingSenderId: "46979426016",
    appId: "1:46979426016:web:fd1fbe341fff6970ae9285"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const categoryMap = {
    cyber: "üî• Cyber Security",
    cloud: "‚òÅÔ∏è Cloud & DevOps",
    blue: "üõ°Ô∏è Blue Team / SOC",
    red: "‚öîÔ∏è Red Team / OffSec",
    bug: "ü™≤ Bug Bounty",
    career: "üìà Kariyer & Sertifikalar",
    genel: "üí¨ Genel Sohbet",
    oyun: "üéÆ Oyun Sohbeti",
    teknoloji: "üí° Teknoloji K√∂≈üesi"
  };

  const params = new URLSearchParams(window.location.search);
  const postId = params.get("id");

  const topicTitleEl = document.getElementById("topicTitle");
  const topicMetaEl = document.getElementById("topicMeta");
  const topicMessageEl = document.getElementById("topicMessage");
  const messagesListEl = document.getElementById("messages-list");
  const nicknameInput = document.getElementById("nickname");
  const messageInput = document.getElementById("message");
  const replyBtn = document.getElementById("replyBtn");
  const likeBtn = document.getElementById("likeBtn");
  const likeCountEl = document.getElementById("likeCount");
  const replyLoginInfo = document.getElementById("replyLoginInfo");

  let currentUser = null;
  let currentUserProfile = null;

  async function loadUserProfile(uid) {
    try {
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) return null;
      return snap.data();
    } catch (e) {
      console.error("Kullanƒ±cƒ± profili √ßekilirken hata:", e);
      return null;
    }
  }

  onAuthStateChanged(auth, async (user) => {
    currentUser = user || null;
    currentUserProfile = null;

    if (!user) {
      replyLoginInfo.textContent =
        "Giri≈ü yaparsan yazdƒ±ƒüƒ±n mesajlar profilinde sayƒ±lƒ±r. (Profilim ‚Üí Giri≈ü)";
      return;
    }

    const profile = await loadUserProfile(user.uid);
    currentUserProfile = profile;

    const username = profile?.username || (user.email ? user.email.split("@")[0] : "Anon");
    replyLoginInfo.textContent = `Giri≈ü yaptƒ±n: ${username} ‚Ä¢ Yazdƒ±ƒüƒ±n mesajlar profil istatistiklerine yazƒ±lacak.`;
    if (!nicknameInput.value.trim()) {
      nicknameInput.placeholder = `${username} (isteƒüe baƒülƒ± deƒüi≈ütirebilirsin)`;
    }
  });

  if (!postId) {
    topicTitleEl.textContent = "Konu bulunamadƒ±";
    topicMetaEl.textContent = "";
    topicMessageEl.textContent = "";
    likeBtn.disabled = true;
  } else {
    loadPost();
    listenReplies();
  }

  async function loadPost() {
    try {
      const ref = doc(db, "posts", postId);
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        topicTitleEl.textContent = "Konu bulunamadƒ±";
        topicMetaEl.textContent = "";
        topicMessageEl.textContent = "";
        likeBtn.disabled = true;
        return;
      }

      const data = snap.data();
      const categoryText = categoryMap[data.category] || "‚ùî Diƒüer";

      let timeText = "";
      if (data.createdAt && data.createdAt.toDate) {
        const d = data.createdAt.toDate();
        timeText = d.toLocaleString("tr-TR", {
          day: "2-digit",
          month: "2-digit",
          hour: "2-digit",
          minute: "2-digit"
        });
      }

      topicTitleEl.textContent = `${categoryText} ‚Ä¢ ${data.title || "Ba≈ülƒ±ksƒ±z Konu"}`;
      topicMetaEl.textContent =
        `Kategori: ${categoryText} ‚Ä¢ A√ßan: ${data.nick || "Anonim"} ‚Ä¢ ${timeText || ""}`;
      topicMessageEl.textContent = data.message || "";

      const likes = typeof data.likes === "number" ? data.likes : 0;
      likeCountEl.textContent = likes;
    } catch (e) {
      console.error("Konu y√ºklenirken hata:", e);
      topicTitleEl.textContent = "Konu y√ºklenirken hata olu≈ütu.";
    }
  }

  function listenReplies() {
    const repliesRef = collection(db, "posts", postId, "replies");
    const q = query(repliesRef, orderBy("createdAt", "asc"));

    onSnapshot(q, (snapshot) => {
      messagesListEl.innerHTML = "";

      if (snapshot.empty) {
        messagesListEl.innerHTML =
          '<div class="msg-item"><div class="msg-body"><div class="msg-text">Hen√ºz yorum yok. ƒ∞lk yorumu sen yaz.</div></div></div>';
        return;
      }

      snapshot.forEach((docSnap) => {
        const data = docSnap.data();

        const wrapper = document.createElement("div");
        wrapper.className = "msg-item";

        const avatar = document.createElement("div");
        avatar.className = "msg-avatar";
        avatar.textContent = (data.nick || "?").charAt(0).toUpperCase();

        const body = document.createElement("div");
        body.className = "msg-body";

        const nameRow = document.createElement("div");
        const nameEl = document.createElement("span");
        nameEl.className = "msg-username";
        nameEl.textContent = data.nick || "Anonim";

        const timeEl = document.createElement("span");
        timeEl.className = "msg-time";

        let t = "";
        if (data.createdAt && data.createdAt.toDate) {
          const d = data.createdAt.toDate();
          t = d.toLocaleString("tr-TR", {
            day: "2-digit",
            month: "2-digit",
            hour: "2-digit",
            minute: "2-digit"
          });
        }
        timeEl.textContent = " ‚Ä¢ " + (t || "");

        nameRow.appendChild(nameEl);
        nameRow.appendChild(timeEl);

        const textEl = document.createElement("div");
        textEl.className = "msg-text";
        textEl.textContent = data.message || "";

        body.appendChild(nameRow);
        body.appendChild(textEl);

        wrapper.appendChild(avatar);
        wrapper.appendChild(body);

        messagesListEl.appendChild(wrapper);
      });
    });
  }

  // Yorum ekleme
  replyBtn.addEventListener("click", async () => {
    if (!postId) {
      alert("Ge√ßersiz konu.");
      return;
    }

    let nick = nicknameInput.value.trim();
    const text = messageInput.value.trim();

    if (!nick) {
      if (currentUserProfile?.username) {
        nick = currentUserProfile.username;
      } else {
        alert("L√ºtfen takma ad gir.");
        return;
      }
    }

    if (!text) {
      alert("L√ºtfen yorum alanƒ±nƒ± doldur.");
      return;
    }

    try {
      const repliesRef = collection(db, "posts", postId, "replies");
      await addDoc(repliesRef, {
        nick,
        message: text,
        createdAt: serverTimestamp(),
        userId: currentUser ? currentUser.uid : null
      });

      const postRef = doc(db, "posts", postId);
      await updateDoc(postRef, {
        replyCount: increment(1),
        lastReplyAt: serverTimestamp()
      });

      // Kullanƒ±cƒ± giri≈üliyse mesaj sayƒ±sƒ±nƒ± artƒ±r
      if (currentUser) {
        const userRef = doc(db, "users", currentUser.uid);
        updateDoc(userRef, {
          "stats.messages": increment(1)
        }).catch((e) => {
          console.warn("Mesaj istatistiƒüi g√ºncellenemedi:", e);
        });
      }

      messageInput.value = "";
    } catch (e) {
      console.error("Yorum eklenirken hata:", e);
      alert("Yorum eklenirken bir hata olu≈ütu.");
    }
  });

  // Beƒüeni
  likeBtn.addEventListener("click", async () => {
    if (!postId) {
      alert("Ge√ßersiz konu.");
      return;
    }

    try {
      const postRef = doc(db, "posts", postId);
      await updateDoc(postRef, {
        likes: increment(1)
      });

      // Ekrandaki sayacƒ± anƒ±nda artƒ±r
      const current = parseInt(likeCountEl.textContent || "0", 10);
      likeCountEl.textContent = current + 1;

      if (currentUser) {
        const userRef = doc(db, "users", currentUser.uid);
        updateDoc(userRef, {
          "stats.likes": increment(1)
        }).catch((e) => {
          console.warn("Like istatistiƒüi g√ºncellenemedi:", e);
        });
      }
    } catch (e) {
      console.error("Beƒüeni eklenirken hata:", e);
      alert("Beƒüeni eklenirken bir hata olu≈ütu.");
    }
  });
</script>

</body>
</html>
