<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NebChat ‚Ä¢ Forum</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Pacifico&display=swap');

    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background: #080d1a;
      color: #dfe4ff;
    }

    header {
      background: rgba(15, 20, 40, 0.7);
      backdrop-filter: blur(10px);
      padding: 18px 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(80, 100, 255, 0.25);
      box-shadow: 0 0 18px rgba(0, 162, 255, 0.25);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .logo-area {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .logo-title {
      font-family: 'Pacifico', cursive;
      font-size: 30px;
      font-weight: 400;
      color: #8ab4ff;
      text-shadow: 0 0 10px rgba(121, 169, 255, 0.9);
    }

    .menu {
      display: flex;
      gap: 16px;
    }

    .menu a {
      color: #a8b4ff;
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid rgba(108, 99, 255, 0.3);
      background: rgba(255, 255, 255, 0.03);
      transition: 0.25s;
    }

    .menu a:hover {
      background: rgba(108, 99, 255, 0.25);
      box-shadow: 0 0 14px rgba(108, 99, 255, 0.5);
      color: #ffffff;
    }

    @media (max-width: 700px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      .menu {
        flex-wrap: wrap;
      }
    }

    .page {
      max-width: 1100px;
      margin: 30px auto 60px;
      padding: 0 16px;
    }

    .page-title {
      font-size: 26px;
      font-weight: 600;
      color: #bcd2ff;
      text-shadow: 0 0 18px rgba(120, 140, 255, 0.8);
      margin-bottom: 6px;
    }

    .page-subtitle {
      font-size: 14px;
      color: #a3aedf;
      opacity: 0.9;
      margin-bottom: 24px;
    }

    .new-topic-box {
      background: rgba(20, 25, 50, 0.7);
      border-radius: 18px;
      padding: 18px 16px;
      border: 1px solid rgba(108, 99, 255, 0.35);
      box-shadow: 0 0 22px rgba(80, 70, 230, 0.5);
      margin-bottom: 26px;
    }

    .new-topic-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #d6e0ff;
    }

    .form-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .form-row input,
    .select-category {
      flex: 1;
      min-width: 160px;
      padding: 9px;
      border-radius: 10px;
      border: 1px solid rgba(108, 99, 255, 0.4);
      background: rgba(255, 255, 255, 0.08);
      color: #ffffff;
      font-size: 13px;
      outline: none;
    }

    .form-row input:focus,
    .select-category:focus,
    textarea:focus {
      border-color: rgba(138, 127, 255, 0.9);
      box-shadow: 0 0 15px rgba(138, 127, 255, 0.7);
    }

    textarea {
      width: 100%;
      min-height: 90px;
      border-radius: 12px;
      border: 1px solid rgba(108, 99, 255, 0.35);
      background: rgba(255, 255, 255, 0.08);
      padding: 10px;
      color: white;
      font-size: 14px;
      resize: vertical;
      margin-bottom: 8px;
    }

    .btn-main {
      padding: 9px 18px;
      border-radius: 10px;
      border: 1px solid rgba(108, 99, 255, 0.7);
      background: rgba(108, 99, 255, 0.5);
      color: #e0e4ff;
      font-size: 14px;
      cursor: pointer;
      transition: 0.25s;
    }

    .btn-main:hover {
      background: rgba(108, 99, 255, 0.7);
      box-shadow: 0 0 20px rgba(108, 99, 255, 0.85);
    }

    .meta-row {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 900px) {
      .meta-row {
        grid-template-columns: 1fr;
      }
    }

    .meta-box {
      background: rgba(16, 20, 45, 0.9);
      border-radius: 16px;
      border: 1px solid rgba(108, 99, 255, 0.4);
      box-shadow: 0 0 20px rgba(80, 70, 230, 0.4);
      padding: 14px 14px 10px;
      font-size: 13px;
    }

    .meta-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #d4ddff;
    }

    .meta-item {
      font-size: 13px;
      margin-bottom: 6px;
      color: #cbd5ff;
    }

    .meta-item a {
      color: #cbd5ff;
      text-decoration: none;
    }

    .meta-item a:hover {
      text-decoration: underline;
    }

    .meta-note {
      font-size: 11px;
      color: #9aa4e0;
      margin-top: 4px;
    }

    .category-block {
      margin-top: 30px;
      padding: 18px 16px 10px;
      border-radius: 18px;
      background: rgba(14, 18, 40, 0.9);
      border: 1px solid rgba(108, 99, 255, 0.4);
      box-shadow: 0 0 22px rgba(80, 70, 230, 0.4);
    }

    .category-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .see-more {
      display: inline-block;
      margin-top: 6px;
      font-size: 13px;
      color: #aeb7ff;
      text-decoration: none;
    }

    .see-more:hover {
      text-decoration: underline;
    }

    .topic-list {
      margin-top: 10px;
    }

    .topic-link {
      text-decoration: none;
      color: inherit;
      display: block;
    }

    .topic-item {
      background: rgba(14, 18, 40, 0.95);
      border-radius: 16px;
      padding: 12px 13px;
      margin-bottom: 8px;
      border: 1px solid rgba(108, 99, 255, 0.3);
      box-shadow: 0 0 18px rgba(88, 80, 255, 0.25);
      cursor: pointer;
      transition: 0.25s;
    }

    .topic-item:hover {
      border-color: rgba(108, 99, 255, 0.7);
      box-shadow: 0 0 24px rgba(88, 80, 255, 0.4);
      transform: translateY(-1px);
    }

    .topic-title {
      font-size: 15px;
      font-weight: 600;
      color: #dfe4ff;
      margin-bottom: 2px;
    }

    .topic-nick {
      font-size: 12px;
      color: #aeb7ff;
    }

    .topic-message-preview {
      font-size: 13px;
      color: #cfd7ff;
      margin-top: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .topic-meta-line {
      margin-top: 4px;
      font-size: 11px;
      color: #9ea7f0;
      opacity: 0.95;
    }

    .no-topics {
      font-size: 13px;
      color: #9da5dd;
      margin-top: 6px;
    }

    footer {
      margin-top: 40px;
      padding: 20px;
      text-align: center;
      font-size: 13px;
      color: #8189c4;
    }
  </style>
</head>

<body>

<header>
  <div class="logo-area">
    <a href="index.html" style="text-decoration:none;">
      <div class="logo-title">NebChat</div>
    </a>
  </div>

  <nav class="menu">
    <a href="index.html">Ana Sayfa</a>
    <a href="forum.html">Forum</a>
    <a href="login.html">Giri≈ü Yap</a>
    <a href="profile.html">Profilim</a>
  </nav>
</header>

<main class="page">
  <h1 class="page-title" id="pageTitle">Son Konular</h1>
  <p class="page-subtitle" id="pageSubtitle">
    Giri≈ü yapmak zorunlu deƒüil. Bir takma ad (nick) se√ß, ba≈ülƒ±ƒüƒ±nƒ± ve mesajƒ±nƒ± yaz. 
    Tech & Security ile ilgili her ≈üey serbest; ki≈üisel veri yok.
  </p>

  <section class="new-topic-box">
    <div class="new-topic-title">Yeni Konu A√ß</div>

    <div class="form-row">
      <input type="text" id="nickInput" placeholder="Takma adƒ±n (√∂r: Nebride)">
      <input type="text" id="titleInput" placeholder="Konu ba≈ülƒ±ƒüƒ±">
    </div>

    <div class="form-row">
      <select id="categoryInput" class="select-category">
        <option value="cyber">üõ° Cyber Security</option>
        <option value="network">üåê Network & Infrastructure</option>
        <option value="cloud">‚òÅÔ∏è Cloud & DevOps</option>
        <option value="career">üíº Career & Salary</option>
        <option value="products">üì¶ Products & Vendors</option>
        <option value="confessions">üôà Anon Confessions</option>
        <option value="tech">üí° Tech Discussions</option>
        <option value="offtopic">üé≠ Off-Topic / Community</option>
      </select>
    </div>

    <textarea id="messageInput" placeholder="Mesajƒ±nƒ± yaz..."></textarea>

    <button class="btn-main" id="sendBtn">Konuyu G√∂nder</button>
  </section>

  <!-- TRENDING + TOP CONTRIBUTORS -->
  <section class="meta-row">
    <div class="meta-box" id="trendingBox">
      <div class="meta-title">üî• Trending Topics</div>
      <div class="meta-note">Son saatlerde en √ßok hareket g√∂ren konular burada √ßƒ±kar.</div>
      <div id="trendingList" style="margin-top:8px;"></div>
    </div>

    <div class="meta-box" id="topContributorsBox">
      <div class="meta-title">üèÜ Top Contributors</div>
      <div class="meta-note">NebScore: likes √ó2 + messages √ó1.5 + topics √ó3</div>
      <div id="contributorsList" style="margin-top:8px;"></div>
    </div>
  </section>

  <section class="topics-list">
    <div id="forumContent"></div>
  </section>
</main>

<footer>
  NebChat anonim forum ‚Ä¢ ƒ∞√ßerik kullanƒ±cƒ±larƒ±n sorumluluƒüundadƒ±r.
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    serverTimestamp,
    query,
    orderBy,
    onSnapshot,
    where,
    limit,
    doc,
    updateDoc,
    increment,
    getDocs
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBAwFSe0pud59OXpx1G5hQO9opA1f7Eg9Y",
    authDomain: "nebchat2.firebaseapp.com",
    projectId: "nebchat2",
    storageBucket: "nebchat2.firebasestorage.app",
    messagingSenderId: "46979426016",
    appId: "1:46979426016:web:fd1fbe341fff6970ae9285"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const categoryMap = {
    cyber: "üõ° Cyber Security",
    network: "üåê Network & Infrastructure",
    cloud: "‚òÅÔ∏è Cloud & DevOps",
    career: "üíº Career & Salary",
    products: "üì¶ Products & Vendors",
    confessions: "üôà Anon Confessions",
    tech: "üí° Tech Discussions",
    offtopic: "üé≠ Off-Topic / Community"
  };

  const params = new URLSearchParams(window.location.search);
  const selectedCat = params.get("cat");

  const pageTitleEl = document.getElementById("pageTitle");
  const pageSubtitleEl = document.getElementById("pageSubtitle");
  const nickInput = document.getElementById("nickInput");
  const titleInput = document.getElementById("titleInput");
  const categoryInput = document.getElementById("categoryInput");
  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const forumContent = document.getElementById("forumContent");

  const trendingListEl = document.getElementById("trendingList");
  const contributorsListEl = document.getElementById("contributorsList");

  let currentUser = null;

  onAuthStateChanged(auth, (user) => {
    currentUser = user || null;
  });

  // Yeni konu g√∂nder
  sendBtn.addEventListener("click", async () => {
    const nick = nickInput.value.trim();
    const title = titleInput.value.trim();
    const message = messageInput.value.trim();
    const category = categoryInput.value;

    if (!nick || !title || !message) {
      alert("L√ºtfen t√ºm alanlarƒ± doldurun.");
      return;
    }

    try {
      await addDoc(collection(db, "posts"), {
        nick,
        title,
        message,
        category,
        createdAt: serverTimestamp(),
        replyCount: 0,
        lastReplyAt: null,
        likes: 0,
        userId: currentUser ? currentUser.uid : null
      });

      if (currentUser) {
        const userRef = doc(db, "users", currentUser.uid);
        await updateDoc(userRef, {
          "stats.topics": increment(1)
        });
      }

      messageInput.value = "";
      titleInput.value = "";
    } catch (e) {
      console.error("Konu eklenirken hata:", e);
      alert("Konu eklenirken bir hata olu≈ütu.");
    }
  });

  function renderCategoryPreview() {
    pageTitleEl.textContent = "Son Konular";
    pageSubtitleEl.textContent =
      "A≈üaƒüƒ±dan Tech & Security kategorilerine g√∂z at, her birinden son konularƒ± g√∂r.";

    forumContent.innerHTML = "";

    const homeCats = [
      "cyber",
      "network",
      "cloud",
      "career",
      "products",
      "confessions",
      "tech",
      "offtopic"
    ];

    for (const cat of homeCats) {
      const label = categoryMap[cat] || cat;

      const section = document.createElement("div");
      section.className = "category-block";
      section.innerHTML = `
        <div class="category-title">${label}</div>
        <div id="list-${cat}" class="topic-list"></div>
        <a class="see-more" href="forum.html?cat=${cat}">T√ºm√ºn√º g√∂r ‚Üí</a>
      `;
      forumContent.appendChild(section);

      const listDiv = section.querySelector("#list-" + cat);

      const qCat = query(
        collection(db, "posts"),
        where("category", "==", cat),
        orderBy("createdAt", "desc"),
        limit(3)
      );

      onSnapshot(qCat, (snapshot) => {
        listDiv.innerHTML = "";

        if (snapshot.empty) {
          listDiv.innerHTML =
            '<p class="no-topics">Bu kategoride hen√ºz konu yok.</p>';
          return;
        }

        snapshot.forEach((docSnap) => {
          const d = docSnap.data();
          const id = docSnap.id;

          const item = document.createElement("a");
          item.className = "topic-link";
          item.href = `topic.html?id=${encodeURIComponent(id)}`;

          const baseTime = d.lastReplyAt?.toDate?.()
            ? d.lastReplyAt.toDate()
            : d.createdAt?.toDate?.();

          const timeText = baseTime
            ? baseTime.toLocaleString("tr-TR", {
                day: "2-digit",
                month: "2-digit",
                hour: "2-digit",
                minute: "2-digit"
              })
            : "";

          const likeCount = typeof d.likes === "number" ? d.likes : 0;

          item.innerHTML = `
            <div class="topic-item">
              <div class="topic-title">${d.title || "Ba≈ülƒ±ksƒ±z konu"}</div>
              <div class="topic-nick">Yazan: ${d.nick || "Anonim"}</div>
              <div class="topic-message-preview">${d.message || ""}</div>
              <div class="topic-meta-line">
                ${(typeof d.replyCount === "number" ? d.replyCount : 0)} yorum
                ‚Ä¢ ${likeCount} beƒüeni
                ${timeText ? " ‚Ä¢ Son hareket: " + timeText : ""}
              </div>
            </div>
          `;
          listDiv.appendChild(item);
        });
      });
    }
  }

  function renderCategoryPage(cat) {
    const label = categoryMap[cat] || "Kategori";

    pageTitleEl.textContent = label;
    pageSubtitleEl.textContent =
      label + " kategorisindeki t√ºm konular listelenir.";

    categoryInput.value = cat;

    forumContent.innerHTML = "";

    const q = query(
      collection(db, "posts"),
      where("category", "==", cat),
      orderBy("createdAt", "desc")
    );

    onSnapshot(q, (snapshot) => {
      forumContent.innerHTML = "";

      if (snapshot.empty) {
        forumContent.innerHTML =
          '<p class="no-topics">Bu kategoride hen√ºz konu yok.</p>';
        return;
      }

      snapshot.forEach((docSnap) => {
        const d = docSnap.data();
        const id = docSnap.id;

        const item = document.createElement("a");
        item.className = "topic-link";
        item.href = `topic.html?id=${encodeURIComponent(id)}`;

        const baseTime = d.lastReplyAt?.toDate?.()
          ? d.lastReplyAt.toDate()
          : d.createdAt?.toDate?.();

        const timeText = baseTime
          ? baseTime.toLocaleString("tr-TR", {
              day: "2-digit",
              month: "2-digit",
              hour: "2-digit",
              minute: "2-digit"
            })
          : "";

        const likeCount = typeof d.likes === "number" ? d.likes : 0;

        item.innerHTML = `
          <div class="topic-item">
            <div class="topic-title">${d.title || "Ba≈ülƒ±ksƒ±z konu"}</div>
            <div class="topic-nick">Yazan: ${d.nick || "Anonim"}</div>
            <div class="topic-message-preview">${d.message || ""}</div>
            <div class="topic-meta-line">
              ${(typeof d.replyCount === "number" ? d.replyCount : 0)} yorum
              ‚Ä¢ ${likeCount} beƒüeni
              ${timeText ? " ‚Ä¢ Son hareket: " + timeText : ""}
            </div>
          </div>
        `;
        forumContent.appendChild(item);
      });
    });
  }

  // TRENDING TOPICS (client-side scoring)
  async function loadTrending() {
    try {
      const postsRef = collection(db, "posts");
      const q = query(postsRef, orderBy("createdAt", "desc"), limit(50));
      const snap = await getDocs(q);

      const now = Date.now();
      const items = [];

      snap.forEach((docSnap) => {
        const d = docSnap.data();
        if (!d.createdAt || !d.createdAt.toDate) return;

        const createdAt = d.createdAt.toDate();
        const ageHours = (now - createdAt.getTime()) / (1000 * 60 * 60);

        const likes = typeof d.likes === "number" ? d.likes : 0;
        const replies = typeof d.replyCount === "number" ? d.replyCount : 0;

        const score = likes * 2 + replies * 1.5 + 1 / (ageHours + 1);

        items.push({
          id: docSnap.id,
          title: d.title || "Ba≈ülƒ±ksƒ±z",
          nick: d.nick || "Anonim",
          category: d.category || "tech",
          likes,
          replies,
          score
        });
      });

      items.sort((a, b) => b.score - a.score);
      const top = items.slice(0, 5);

      if (top.length === 0) {
        trendingListEl.innerHTML = '<div class="meta-note">Hen√ºz yeterli hareket yok.</div>';
        return;
      }

      trendingListEl.innerHTML = "";
      top.forEach((item) => {
        const catText = categoryMap[item.category] || "üí° Tech";
        const div = document.createElement("div");
        div.className = "meta-item";
        div.innerHTML = `
          <a href="topic.html?id=${encodeURIComponent(item.id)}">
            ${catText} ‚Ä¢ <strong>${item.title}</strong>
          </a>
          <div style="font-size:11px;color:#9aa4e0;">
            ${item.replies} yorum ‚Ä¢ ${item.likes} beƒüeni
          </div>
        `;
        trendingListEl.appendChild(div);
      });
    } catch (e) {
      console.error("Trending y√ºklenirken hata:", e);
      trendingListEl.innerHTML = '<div class="meta-note">Trending verisi alƒ±namadƒ±.</div>';
    }
  }

  // TOP CONTRIBUTORS
  async function loadTopContributors() {
    try {
      const usersRef = collection(db, "users");
      const snap = await getDocs(usersRef);

      const arr = [];

      snap.forEach((docSnap) => {
        const data = docSnap.data();
        const username = data.username || "Anon";
        const stats = data.stats || {};
        const messages = typeof stats.messages === "number" ? stats.messages : 0;
        const topics = typeof stats.topics === "number" ? stats.topics : 0;
        const likes = typeof stats.likes === "number" ? stats.likes : 0;

        const nebScore = Math.round(likes * 2 + messages * 1.5 + topics * 3);

        arr.push({
          username,
          messages,
          topics,
          likes,
          nebScore
        });
      });

      arr.sort((a, b) => b.nebScore - a.nebScore);
      const top = arr.slice(0, 5);

      if (top.length === 0) {
        contributorsListEl.innerHTML = '<div class="meta-note">Hen√ºz kayƒ±tlƒ± contributor yok.</div>';
        return;
      }

      contributorsListEl.innerHTML = "";
      top.forEach((user, index) => {
        const div = document.createElement("div");
        div.className = "meta-item";
        div.innerHTML = `
          <strong>#${index + 1} ${user.username}</strong>
          <div style="font-size:11px;color:#9aa4e0;">
            NebScore: ${user.nebScore} ‚Ä¢ Topics: ${user.topics} ‚Ä¢ Msg: ${user.messages} ‚Ä¢ Likes: ${user.likes}
          </div>
        `;
        contributorsListEl.appendChild(div);
      });
    } catch (e) {
      console.error("Top contributors y√ºklenirken hata:", e);
      contributorsListEl.innerHTML = '<div class="meta-note">Contributor verisi alƒ±namadƒ±.</div>';
    }
  }

  if (selectedCat && categoryMap[selectedCat]) {
    renderCategoryPage(selectedCat);
  } else {
    renderCategoryPreview();
  }

  // Paket 1: trending + top contributors √ßalƒ±≈ütƒ±r
  loadTrending();
  loadTopContributors();
</script>

</body>
</html>
