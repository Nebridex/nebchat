<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NebChat ‚Ä¢ Forum</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Pacifico&display=swap');

    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background: #080d1a;
      color: #dfe4ff;
    }

    header {
      background: rgba(15, 20, 40, 0.9);
      backdrop-filter: blur(10px);
      padding: 18px 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(80, 100, 255, 0.25);
      box-shadow: 0 0 18px rgba(0, 162, 255, 0.25);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .logo-title {
      font-family: 'Pacifico', cursive;
      font-size: 30px;
      color: #8ab4ff;
      text-shadow: 0 0 10px rgba(121, 169, 255, 0.9);
    }

    .menu {
      display: flex;
      gap: 16px;
    }

    .menu a {
      color: #a8b4ff;
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(108, 99, 255, 0.3);
      background: rgba(255, 255, 255, 0.03);
      transition: 0.25s;
    }

    .menu a:hover {
      background: rgba(108, 99, 255, 0.3);
      box-shadow: 0 0 14px rgba(108, 99, 255, 0.6);
      color: #ffffff;
    }

    main.page {
      max-width: 1100px;
      margin: 30px auto 60px;
      padding: 0 16px;
    }

    .page-title {
      font-size: 26px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #dfe6ff;
      text-shadow: 0 0 18px rgba(120,140,255,0.7);
    }

    .page-subtitle {
      font-size: 14px;
      color: #a3aedf;
      margin-bottom: 20px;
    }

    .new-topic-box {
      background: radial-gradient(circle at top left, rgba(108, 99, 255, 0.6), rgba(10, 10, 30, 0.95));
      border-radius: 20px;
      padding: 20px 18px 18px;
      border: 1px solid rgba(108, 99, 255, 0.55);
      box-shadow: 0 0 32px rgba(80, 70, 230, 0.6);
      margin-bottom: 26px;
    }

    .new-topic-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #d6e0ff;
    }

    .form-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .form-row input,
    .select-category {
      flex: 1;
      min-width: 160px;
      padding: 9px;
      border-radius: 10px;
      border: 1px solid rgba(108, 99, 255, 0.4);
      background: rgba(7, 12, 30, 0.9);
      color: #ffffff;
      font-size: 13px;
      outline: none;
    }

    .form-row input:focus,
    .select-category:focus,
    textarea:focus {
      border-color: rgba(138, 127, 255, 0.9);
      box-shadow: 0 0 15px rgba(138, 127, 255, 0.7);
    }

    textarea {
      width: 100%;
      min-height: 90px;
      border-radius: 12px;
      border: 1px solid rgba(108, 99, 255, 0.35);
      background: rgba(7, 12, 30, 0.95);
      padding: 10px;
      color: white;
      font-size: 14px;
      resize: vertical;
      margin-bottom: 8px;
    }

    .btn-main {
      padding: 9px 18px;
      border-radius: 10px;
      border: 1px solid rgba(108, 99, 255, 0.7);
      background: rgba(108, 99, 255, 0.85);
      color: #e0e4ff;
      font-size: 14px;
      cursor: pointer;
      transition: 0.25s;
    }

    .btn-main:hover {
      background: rgba(108, 99, 255, 1);
      box-shadow: 0 0 20px rgba(108, 99, 255, 0.85);
    }

    .login-indicator {
      font-size: 11px;
      color: #cdd6ff;
      margin-top: 4px;
      opacity: 0.85;
    }

    .all-topics-block {
      margin-top: 28px;
      padding: 18px 16px 16px;
      border-radius: 18px;
      background: rgba(14, 18, 40, 0.95);
      border: 1px solid rgba(108, 99, 255, 0.4);
      box-shadow: 0 0 22px rgba(80, 70, 230, 0.4);
    }

    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
      font-size: 12px;
      color: #a3aedf;
    }

    .filter-bar input,
    .filter-bar select {
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid rgba(108, 99, 255, 0.4);
      background: rgba(7, 12, 30, 0.9);
      color: #ffffff;
      font-size: 12px;
      outline: none;
      min-width: 130px;
    }

    .topic-list {
      margin-top: 6px;
    }

    .topic-link {
      text-decoration: none;
      color: inherit;
      display: block;
    }

    .topic-item {
      background: rgba(10, 14, 32, 0.98);
      border-radius: 16px;
      padding: 12px 13px;
      margin-bottom: 8px;
      border: 1px solid rgba(108, 99, 255, 0.3);
      box-shadow: 0 0 18px rgba(88, 80, 255, 0.25);
      cursor: pointer;
      transition: 0.25s;
    }

    .topic-item:hover {
      border-color: rgba(108, 99, 255, 0.7);
      box-shadow: 0 0 24px rgba(88, 80, 255, 0.4);
      transform: translateY(-1px);
    }

    .topic-title {
      font-size: 15px;
      font-weight: 600;
      color: #dfe4ff;
      margin-bottom: 2px;
    }

    .topic-nick {
      font-size: 12px;
      color: #aeb7ff;
    }

    .topic-message-preview {
      font-size: 13px;
      color: #cfd7ff;
      margin-top: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .topic-meta-line {
      margin-top: 4px;
      font-size: 11px;
      color: #9ea7f0;
      opacity: 0.95;
    }

    .badge-registered {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(108, 99, 255, 0.2);
      border: 1px solid rgba(108, 99, 255, 0.7);
      margin-left: 4px;
    }

    .badge-guest {
      font-size: 10px;
      opacity: 0.7;
      margin-left: 4px;
    }

    .no-topics {
      font-size: 13px;
      color: #9da5dd;
      margin-top: 6px;
    }

    footer {
      margin-top: 40px;
      padding: 20px;
      text-align: center;
      font-size: 13px;
      color: #8189c4;
    }
  </style>
</head>

<body>
<header>
  <a href="index.html" style="text-decoration:none;">
    <div class="logo-title">NebChat</div>
  </a>

  <nav class="menu">
    <a href="index.html">Ana Sayfa</a>
    <a href="forum.html">Forum</a>
    <a href="profile.html">Profilim</a>
  </nav>
</header>

<main class="page">
  <h1 class="page-title">Son Konular</h1>
  <p class="page-subtitle">
    Giri≈ü yapmak zorunlu deƒüil. Bir takma ad (guest) veya kayƒ±tlƒ± kullanƒ±cƒ± adƒ± ile yazabilirsin.
    Kayƒ±tlƒ± kullanƒ±cƒ± adlarƒ± rezerve edilir, ba≈ükasƒ± kullanamaz.
  </p>

  <section class="new-topic-box">
    <div class="new-topic-title">Yeni Konu A√ß</div>

    <div class="form-row">
      <input type="text" id="nickInput" placeholder="Takma adƒ±n (guest kullanƒ±cƒ±lar i√ßin)">
      <input type="text" id="titleInput" placeholder="Konu ba≈ülƒ±ƒüƒ± (√∂r: SIEM Rule Tuning)">
    </div>

    <div class="form-row">
      <select id="categoryInput" class="select-category">
        <option value="cyber">üõ° Cyber Security</option>
        <option value="network">üåê Network & Infrastructure</option>
        <option value="cloud">‚òÅÔ∏è Cloud & DevOps</option>
        <option value="career">üíº Career & Salary</option>
        <option value="products">üì¶ Products & Vendors</option>
        <option value="anon">üôà Anon Confessions</option>
        <option value="tech">üí° Tech Discussions</option>
        <option value="community">üé≠ Off-Topic / Community</option>
      </select>
    </div>

    <textarea id="messageInput" placeholder="Mesajƒ±nƒ± yaz..."></textarea>

    <button class="btn-main" id="sendBtn">Konuyu G√∂nder</button>
    <div class="login-indicator" id="loginIndicator">
      Giri≈ü yaparsan forumdaki t√ºm yazƒ±larƒ±n KENDƒ∞ kullanƒ±cƒ± adƒ±nla g√∂r√ºn√ºr, kimse o adƒ± kullanamaz.
    </div>
  </section>

  <section class="all-topics-block">
    <div class="filter-bar">
      <input type="text" id="searchInput" placeholder="Ba≈ülƒ±k / mesaj / nick ara...">
      <select id="filterCategory">
        <option value="all">T√ºm kategoriler</option>
        <option value="cyber">üõ° Cyber Security</option>
        <option value="network">üåê Network & Infrastructure</option>
        <option value="cloud">‚òÅÔ∏è Cloud & DevOps</option>
        <option value="career">üíº Career & Salary</option>
        <option value="products">üì¶ Products & Vendors</option>
        <option value="anon">üôà Anon Confessions</option>
        <option value="tech">üí° Tech Discussions</option>
        <option value="community">üé≠ Off-Topic / Community</option>
      </select>
      <select id="sortSelect">
        <option value="newest">En yeni</option>
        <option value="mostReplies">En √ßok yorum</option>
        <option value="mostLikes">En √ßok beƒüeni</option>
      </select>
    </div>

    <div class="topic-list" id="allTopicsList"></div>
  </section>
</main>

<footer>
  NebChat anonim forum ‚Ä¢ Kullanƒ±cƒ± adlarƒ± kayƒ±tlƒ±dƒ±r, guest nick‚Äôler ayrƒ± g√∂sterilir.
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    serverTimestamp,
    query,
    orderBy,
    onSnapshot,
    doc,
    updateDoc,
    increment,
    getDoc,
    getDocs,
    where
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBAwFSe0pud59OXpx1G5hQO9opA1f7Eg9Y",
    authDomain: "nebchat2.firebaseapp.com",
    projectId: "nebchat2",
    storageBucket: "nebchat2.firebasestorage.app",
    messagingSenderId: "46979426016",
    appId: "1:46979426016:web:fd1fbe341fff6970ae9285"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const nickInput = document.getElementById("nickInput");
  const titleInput = document.getElementById("titleInput");
  const categoryInput = document.getElementById("categoryInput");
  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const loginIndicator = document.getElementById("loginIndicator");

  const searchInput = document.getElementById("searchInput");
  const filterCategory = document.getElementById("filterCategory");
  const sortSelect = document.getElementById("sortSelect");
  const allTopicsList = document.getElementById("allTopicsList");

  const urlParams = new URLSearchParams(window.location.search);
  const initialCategory = urlParams.get("category");

  if (initialCategory) {
    filterCategory.value = initialCategory;
    categoryInput.value = initialCategory;
  }

  const categoryLabel = {
    cyber: "üõ° Cyber Security",
    network: "üåê Network & Infrastructure",
    cloud: "‚òÅÔ∏è Cloud & DevOps",
    career: "üíº Career & Salary",
    products: "üì¶ Products & Vendors",
    anon: "üôà Anon Confessions",
    tech: "üí° Tech Discussions",
    community: "üé≠ Off-Topic / Community",
    // eski postlar i√ßin legacy:
    blue: "Blue Team / SOC",
    red: "Red Team / OffSec",
    bug: "Bug Bounty",
    genel: "Genel Sohbet"
  };

  let currentUser = null;
  let currentUserProfile = null;
  let allPosts = [];

  async function loadUserProfile(uid) {
    try {
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) return null;
      return snap.data();
    } catch (e) {
      console.error("Kullanƒ±cƒ± profili alƒ±namadƒ±:", e);
      return null;
    }
  }

  function validateGuestNick(nick) {
    if (!nick) return false;
    if (nick.trim().length < 2) return false;
    return true;
  }

  async function isNickReserved(nick) {
    const lower = nick.trim().toLowerCase();
    if (!lower) return false;
    const q = query(collection(db, "users"), where("usernameLower", "==", lower));
    const snap = await getDocs(q);
    return !snap.empty;
  }

  onAuthStateChanged(auth, async (user) => {
    currentUser = user || null;
    currentUserProfile = null;

    if (!user) {
      loginIndicator.textContent =
        "Giri≈ü yaparsan t√ºm mesajlarƒ±n kayƒ±tlƒ± kullanƒ±cƒ± adƒ±nla g√∂r√ºn√ºr. Guest‚Äôler kayƒ±tlƒ± nick kullanamaz.";
      nickInput.disabled = false;
      nickInput.placeholder = "Takma adƒ±n (guest i√ßin, √∂r: siber-guest)";
      return;
    }

    const profile = await loadUserProfile(user.uid);
    currentUserProfile = profile;

    const username =
      profile?.username ||
      (user.email ? user.email.split("@")[0] : "Kayƒ±tlƒ± Kullanƒ±cƒ±");
    loginIndicator.textContent =
      `Giri≈ü yaptƒ±n: ${username}. Forumda yazdƒ±klarƒ±n bu kullanƒ±cƒ± adƒ± ile g√∂r√ºnecek.`;
    nickInput.value = "";
    nickInput.disabled = true;
    nickInput.placeholder = `${username} (kayƒ±tlƒ± kullanƒ±cƒ± adƒ±)`;
  });

  sendBtn.addEventListener("click", async () => {
    let nick;
    const title = titleInput.value.trim();
    const message = messageInput.value.trim();
    const category = categoryInput.value;

    if (!title || !message) {
      alert("Ba≈ülƒ±k ve mesaj zorunlu.");
      return;
    }

    if (currentUser) {
      nick = currentUserProfile?.username ||
        (currentUser.email ? currentUser.email.split("@")[0] : "Kayƒ±tlƒ± Kullanƒ±cƒ±");
    } else {
      nick = nickInput.value.trim();
      if (!validateGuestNick(nick)) {
        alert("Ge√ßerli bir takma ad gir (min 2 karakter).");
        return;
      }
      if (await isNickReserved(nick)) {
        alert("Bu nick kayƒ±tlƒ± bir kullanƒ±cƒ±ya ait. Farklƒ± bir takma ad kullan.");
        return;
      }
    }

    try {
      await addDoc(collection(db, "posts"), {
        nick,
        title,
        message,
        category,
        createdAt: serverTimestamp(),
        replyCount: 0,
        lastReplyAt: null,
        likes: 0,
        userId: currentUser ? currentUser.uid : null,
        solutionReplyId: null
      });

      if (currentUser) {
        const userRef = doc(db, "users", currentUser.uid);
        updateDoc(userRef, {
          "stats.topics": increment(1),
          "stats.messages": increment(1)
        }).catch((e) => console.warn("ƒ∞statistik g√ºncellenemedi:", e));
      }

      titleInput.value = "";
      messageInput.value = "";
    } catch (e) {
      console.error("Konu eklenirken hata:", e);
      alert("Konu eklenirken bir hata olu≈ütu.");
    }
  });

  function renderAllTopics() {
    allTopicsList.innerHTML = "";

    if (!allPosts.length) {
      allTopicsList.innerHTML = '<p class="no-topics">Hen√ºz konu a√ßƒ±lmamƒ±≈ü.</p>';
      return;
    }

    const term = (searchInput.value || "").toLowerCase().trim();
    const cat = filterCategory.value;
    const sortMode = sortSelect.value;

    let filtered = allPosts.filter((p) => {
      if (cat !== "all" && p.category !== cat) return false;

      if (term) {
        const haystack = [
          p.title || "",
          p.message || "",
          p.nick || ""
        ].join(" ").toLowerCase();
        if (!haystack.includes(term)) return false;
      }

      return true;
    });

    filtered.sort((a, b) => {
      const repliesA = typeof a.replyCount === "number" ? a.replyCount : 0;
      const repliesB = typeof b.replyCount === "number" ? b.replyCount : 0;
      const likesA = typeof a.likes === "number" ? a.likes : 0;
      const likesB = typeof b.likes === "number" ? b.likes : 0;

      const createdA = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
      const createdB = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;

      if (sortMode === "mostReplies") {
        return repliesB - repliesA || createdB - createdA;
      }
      if (sortMode === "mostLikes") {
        return likesB - likesA || createdB - createdA;
      }
      return createdB - createdA;
    });

    filtered.forEach((d) => {
      const id = d._id;

      const baseTime = d.lastReplyAt?.toDate?.()
        ? d.lastReplyAt.toDate()
        : d.createdAt?.toDate?.();

      const timeText = baseTime
        ? baseTime.toLocaleString("tr-TR", {
            day: "2-digit",
            month: "2-digit",
            hour: "2-digit",
            minute: "2-digit"
          })
        : "";

      const catText = categoryLabel[d.category] || "Kategori";
      const previewRaw = d.message || "";
      const preview =
        previewRaw.length > 140 ? previewRaw.slice(0, 140) + "..." : previewRaw;

      const replyCount = typeof d.replyCount === "number" ? d.replyCount : 0;
      const likeCount = typeof d.likes === "number" ? d.likes : 0;

      const regBadge = d.userId
        ? '<span class="badge-registered">registered</span>'
        : '<span class="badge-guest">guest</span>';

      const item = document.createElement("a");
      item.className = "topic-link";
      item.href = `topic.html?id=${encodeURIComponent(id)}`;
      item.innerHTML = `
        <div class="topic-item">
          <div class="topic-title">${catText} ‚Ä¢ ${d.title || "Ba≈ülƒ±ksƒ±z konu"}</div>
          <div class="topic-nick">
            ${d.nick || "Anonim"} ${regBadge}
          </div>
          <div class="topic-message-preview">${preview}</div>
          <div class="topic-meta-line">
            ${replyCount} yorum ‚Ä¢ ${likeCount} beƒüeni
            ${timeText ? " ‚Ä¢ Son hareket: " + timeText : ""}
          </div>
        </div>
      `;
      allTopicsList.appendChild(item);
    });
  }

  function listenAllTopics() {
    const q = query(
      collection(db, "posts"),
      orderBy("createdAt", "desc")
    );

    onSnapshot(q, (snapshot) => {
      allPosts = [];
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        data._id = docSnap.id;
        allPosts.push(data);
      });
      renderAllTopics();
    });
  }

  [searchInput, filterCategory, sortSelect].forEach((el) => {
    el.addEventListener("input", renderAllTopics);
    el.addEventListener("change", renderAllTopics);
  });

  listenAllTopics();
</script>

</body>
</html>
