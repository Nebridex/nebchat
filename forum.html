<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NebChat ‚Ä¢ Forum</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Pacifico&display=swap');

    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background: #080d1a;
      color: #dfe4ff;
    }

    header {
      background: rgba(15, 20, 40, 0.9);
      backdrop-filter: blur(10px);
      padding: 18px 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(80, 100, 255, 0.25);
      box-shadow: 0 0 18px rgba(0, 162, 255, 0.25);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .logo-title {
      font-family: 'Pacifico', cursive;
      font-size: 32px;
      color: #8ab4ff;
      text-shadow: 0 0 10px rgba(121, 169, 255, 0.9);
    }

    .menu {
      display: flex;
      gap: 16px;
    }

    .menu a {
      color: #a8b4ff;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(108, 99, 255, 0.3);
      background: rgba(255, 255, 255, 0.03);
      text-decoration: none;
      transition: .2s;
    }

    .menu a:hover {
      background: rgba(108, 99, 255, .3);
      color: white;
    }

    main.page {
      max-width: 1100px;
      margin: 30px auto 60px;
      padding: 0 16px;
    }

    .page-title {
      font-size: 26px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .new-topic-box {
      background: radial-gradient(circle at top left, rgba(108, 99, 255, 0.6), rgba(10, 10, 30, 0.95));
      padding: 20px;
      border-radius: 20px;
      border: 1px solid rgba(108, 99, 255, 0.55);
      box-shadow: 0 0 25px rgba(108, 99, 255, .4);
      margin-bottom: 25px;
    }

    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    input, select, textarea {
      background: rgba(7, 12, 30, 0.95);
      border: 1px solid rgba(108, 99, 255, 0.4);
      padding: 10px;
      border-radius: 10px;
      color: white;
      width: 100%;
    }

    textarea {
      min-height: 90px;
      resize: vertical;
    }

    button.btn-main {
      padding: 10px 16px;
      border-radius: 10px;
      background: rgba(108,99,255,.8);
      border: 1px solid rgba(108,99,255,.9);
      color: white;
      cursor: pointer;
      transition: .2s;
    }

    button.btn-main:hover {
      background: rgba(108,99,255,1);
      box-shadow: 0 0 20px rgba(108,99,255, .8);
    }

    .all-topics-block {
      background: rgba(14,18,40,.95);
      padding: 18px;
      border-radius: 20px;
      border: 1px solid rgba(108, 99, 255, 0.35);
      box-shadow: 0 0 22px rgba(80,70,230,.4);
      margin-top: 30px;
    }

    .topic-item {
      background: rgba(10,14,32,.98);
      border-radius: 16px;
      padding: 14px;
      border: 1px solid rgba(108,99,255,.25);
      margin-bottom: 10px;
      transition: .2s;
      cursor: pointer;
      text-decoration: none;
      color: white;
      display: block;
    }

    .topic-item:hover {
      border-color: rgba(108,99,255,.7);
      box-shadow: 0 0 20px rgba(108,99,255,.4);
    }

  </style>
</head>

<body>

<header>
  <a href="index.html" style="text-decoration:none;">
    <div class="logo-title">NebChat</div>
  </a>

  <nav class="menu">
    <a href="index.html">Ana Sayfa</a>
    <a href="forum.html">Forum</a>
    <a href="profile.html">Profilim</a>
  </nav>
</header>

<main class="page">
  <h1 class="page-title">Son Konular</h1>

  <section class="new-topic-box">
    <div class="new-topic-title">Yeni Konu A√ß</div>

    <div class="form-row">
      <input id="nickInput" placeholder="Takma ad (√∂r: Nebride)">
      <input id="titleInput" placeholder="Konu ba≈ülƒ±ƒüƒ±">
    </div>

    <div class="form-row">
      <select id="categoryInput">
        <option value="cyber">üõ° Cyber Security</option>
        <option value="network">üåê Network & Infrastructure</option>
        <option value="cloud">‚òÅÔ∏è Cloud & DevOps</option>
        <option value="career">üíº Career & Salary</option>
        <option value="products">üì¶ Products & Vendors</option>
        <option value="anon">üôà Anon Confessions</option>
        <option value="tech">üí° Tech Discussions</option>
        <option value="community">üé≠ Off-Topic / Community</option>
      </select>
    </div>

    <textarea id="messageInput" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..."></textarea>

    <button class="btn-main" id="sendBtn">Konuyu G√∂nder</button>
    <div id="loginIndicator" style="font-size:11px; opacity:.7; margin-top:6px;">
      Giri≈ü yaparsan konular profilinde g√∂r√ºnecek.
    </div>
  </section>

  <section class="all-topics-block">
    <div class="filter-bar">
      <input id="searchInput" placeholder="Ara...">
      <select id="filterCategory">
        <option value="all">T√ºm kategoriler</option>
        <option value="cyber">üõ° Cyber Security</option>
        <option value="network">üåê Network & Infrastructure</option>
        <option value="cloud">‚òÅÔ∏è Cloud & DevOps</option>
        <option value="career">üíº Career & Salary</option>
        <option value="products">üì¶ Products & Vendors</option>
        <option value="anon">üôà Anon Confessions</option>
        <option value="tech">üí° Tech Discussions</option>
        <option value="community">üé≠ Off-Topic / Community</option>
      </select>

      <select id="sortSelect">
        <option value="newest">En Yeni</option>
        <option value="mostReplies">En √áok Yorum</option>
        <option value="mostLikes">En √áok Beƒüeni</option>
      </select>
    </div>

    <div id="allTopicsList"></div>
  </section>
</main>

<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, serverTimestamp,
    query, orderBy, onSnapshot, doc, updateDoc, increment, getDoc
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  import { getAuth, onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBAwFSe0pud59OXpx1G5hQO9opA1f7Eg9Y",
    authDomain: "nebchat2.firebaseapp.com",
    projectId: "nebchat2",
    storageBucket: "nebchat2.firebasestorage.app",
    messagingSenderId: "46979426016",
    appId: "1:46979426016:web:fd1fbe341fff6970ae9285"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const nickInput = document.getElementById("nickInput");
  const titleInput = document.getElementById("titleInput");
  const categoryInput = document.getElementById("categoryInput");
  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");

  const searchInput = document.getElementById("searchInput");
  const filterCategory = document.getElementById("filterCategory");
  const sortSelect = document.getElementById("sortSelect");
  const allTopicsList = document.getElementById("allTopicsList");

  let currentUser = null;
  let currentProfile = null;
  let allPosts = [];

  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    if (!user) return;

    let ref = doc(db, "users", user.uid);
    let snap = await getDoc(ref);
    currentProfile = snap.exists() ? snap.data() : null;

    if (currentProfile?.username) {
      nickInput.placeholder = currentProfile.username;
    }
  });

  sendBtn.addEventListener("click", async () => {
    let nick = nickInput.value.trim() || currentProfile?.username || "Anon";
    let title = titleInput.value.trim();
    let msg = messageInput.value.trim();
    let cat = categoryInput.value;

    if (!title || !msg) return alert("Ba≈ülƒ±k ve mesaj zorunlu.");

    await addDoc(collection(db, "posts"), {
      nick, title, message: msg, category: cat,
      createdAt: serverTimestamp(),
      replyCount: 0,
      likes: 0,
      userId: currentUser?.uid || null,
      lastReplyAt: null
    });

    if (currentUser) {
      updateDoc(doc(db, "users", currentUser.uid), {
        "stats.topics": increment(1),
        "stats.messages": increment(1)
      });
    }

    titleInput.value = "";
    messageInput.value = "";
  });

  const labelMap = {
    cyber: "üõ° Cyber Security",
    network: "üåê Network & Infrastructure",
    cloud: "‚òÅÔ∏è Cloud & DevOps",
    career: "üíº Career & Salary",
    products: "üì¶ Products & Vendors",
    anon: "üôà Anon Confessions",
    tech: "üí° Tech Discussions",
    community: "üé≠ Off-Topic / Community",

    blue: "Blue Team / SOC",
    red: "Red Team / OffSec",
    bug: "Bug Bounty",
    genel: "Genel Sohbet"
  };

  const params = new URLSearchParams(location.search);
  const initial = params.get("category");
  if (initial) {
    filterCategory.value = initial;
    categoryInput.value = initial;
  }

  function renderTopics() {
    allTopicsList.innerHTML = "";

    let term = searchInput.value.toLowerCase().trim();
    let cat = filterCategory.value;
    let sort = sortSelect.value;

    let list = allPosts.filter(p => {
      if (cat !== "all" && p.category !== cat) return false;

      let hay = (p.title + " " + p.message + " " + p.nick).toLowerCase();
      if (term && !hay.includes(term)) return false;

      return true;
    });

    list.sort((a, b) => {
      if (sort === "mostReplies") return b.replyCount - a.replyCount;
      if (sort === "mostLikes") return b.likes - a.likes;
      return (b.createdAt?.toDate?.() || 0) - (a.createdAt?.toDate?.() || 0);
    });

    for (let p of list) {
      let t = document.createElement("a");
      t.href = "topic.html?id=" + p._id;
      t.className = "topic-item";

      let time = p.createdAt?.toDate
        ? p.createdAt.toDate().toLocaleString("tr-TR")
        : "";

      t.innerHTML = `
        <div class="topic-title">${labelMap[p.category] || "Kategori"} ‚Ä¢ ${p.title}</div>
        <div>${p.nick}</div>
        <div style="opacity:.7; font-size:12px;">
          ${p.replyCount} yorum ‚Ä¢ ${p.likes} beƒüeni ‚Ä¢ ${time}
        </div>
      `;
      allTopicsList.appendChild(t);
    }
  }

  onSnapshot(query(collection(db, "posts"), orderBy("createdAt", "desc")),
    snap => {
      allPosts = snap.docs.map(d => ({ _id: d.id, ...d.data() }));
      renderTopics();
    }
  );

  searchInput.addEventListener("input", renderTopics);
  filterCategory.addEventListener("change", renderTopics);
  sortSelect.addEventListener("change", renderTopics);

</script>

</body>
</html>
