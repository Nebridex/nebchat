<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NebChat â€¢ Forum</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Pacifico&display=swap');

    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background: #080d1a;
      color: #dfe4ff;
    }

    header {
      background: rgba(15, 20, 40, 0.7);
      backdrop-filter: blur(10px);
      padding: 18px 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(80, 100, 255, 0.25);
      box-shadow: 0 0 18px rgba(0, 162, 255, 0.25);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .logo-area {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .logo-title {
      font-family: 'Pacifico', cursive;
      font-size: 34px;
      font-weight: 400;
      color: #8ab4ff;
      text-shadow: 0 0 10px rgba(121, 169, 255, 0.9);
      letter-spacing: 0.5px;
    }

    .menu {
      display: flex;
      gap: 16px;
    }

    .menu a {
      color: #a8b4ff;
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid rgba(108, 99, 255, 0.3);
      background: rgba(255, 255, 255, 0.03);
      transition: 0.25s;
    }

    .menu a:hover {
      background: rgba(108, 99, 255, 0.25);
      box-shadow: 0 0 14px rgba(108, 99, 255, 0.5);
      color: #ffffff;
    }

    .page {
      max-width: 1100px;
      margin: 30px auto 60px;
      padding: 0 16px;
    }

    .page-title {
      font-size: 26px;
      font-weight: 600;
      color: #bcd2ff;
      text-shadow: 0 0 18px rgba(120, 140, 255, 0.8);
      margin-bottom: 6px;
    }

    .page-subtitle {
      font-size: 14px;
      color: #a3aedf;
      opacity: 0.9;
      margin-bottom: 24px;
    }

    .category-title {
      font-size: 22px;
      font-weight: 600;
      margin-top: 40px;
      margin-bottom: 12px;
      color: #dfe4ff;
      text-shadow: 0 0 10px rgba(120, 140, 255, 0.8);
    }

    /* YENÄ° KONU FORMU */
    .new-topic-box {
      background: rgba(20, 25, 50, 0.7);
      border-radius: 18px;
      padding: 18px 16px;
      border: 1px solid rgba(108, 99, 255, 0.35);
      box-shadow: 0 0 22px rgba(80, 70, 230, 0.5);
      margin-bottom: 26px;
    }

    .new-topic-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #d6e0ff;
    }

    .form-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .form-row input, .select-category {
      flex: 1;
      min-width: 160px;
      padding: 9px;
      border-radius: 10px;
      border: 1px solid rgba(108, 99, 255, 0.4);
      background: rgba(255, 255, 255, 0.08);
      color: #ffffff;
      font-size: 13px;
      outline: none;
    }

    textarea {
      width: 100%;
      min-height: 90px;
      border-radius: 12px;
      border: 1px solid rgba(108, 99, 255, 0.35);
      background: rgba(255, 255, 255, 0.08);
      padding: 10px;
      color: white;
      font-size: 14px;
      resize: vertical;
      margin-bottom: 8px;
    }

    .btn-main {
      padding: 9px 18px;
      border-radius: 10px;
      border: 1px solid rgba(108, 99, 255, 0.7);
      background: rgba(108, 99, 255, 0.5);
      color: #e0e4ff;
      font-size: 14px;
      cursor: pointer;
      transition: 0.25s;
    }

    .btn-main:hover {
      background: rgba(108, 99, 255, 0.7);
      box-shadow: 0 0 20px rgba(108, 99, 255, 0.85);
    }

    .topic-list {
      margin-bottom: 25px;
    }

    .topic-item {
      background: rgba(14, 18, 40, 0.95);
      border-radius: 16px;
      padding: 14px 13px;
      margin-bottom: 10px;
      border: 1px solid rgba(108, 99, 255, 0.3);
      box-shadow: 0 0 18px rgba(88, 80, 255, 0.25);
      transition: 0.25s;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
    }

    .topic-item:hover {
      border-color: rgba(108, 99, 255, 0.7);
      box-shadow: 0 0 24px rgba(88, 80, 255, 0.4);
      transform: translateY(-1px);
    }

    .topic-title {
      font-size: 15px;
      font-weight: 600;
      color: #dfe4ff;
    }

    .topic-nick {
      font-size: 12px;
      color: #aeb7ff;
    }

    .topic-message {
      font-size: 13px;
      color: #cfd7ff;
      margin-top: 4px;
      white-space: pre-wrap;
    }

    .topic-meta-line {
      margin-top: 6px;
      font-size: 11px;
      color: #9ea7f0;
      opacity: 0.95;
    }

    .see-more {
      font-size: 13px;
      margin-bottom: 25px;
      color: #8aa0ff;
      text-decoration: none;
    }

    .see-more:hover {
      text-decoration: underline;
    }

    footer {
      margin-top: 40px;
      padding: 20px;
      text-align: center;
      font-size: 13px;
      color: #8189c4;
      border-top: 1px solid rgba(80, 100, 255, 0.25);
    }
  </style>
</head>

<body>

<header>
  <div class="logo-area">
    <a href="index.html"><div class="logo-title">NebChat</div></a>
  </div>

  <nav class="menu">
    <a href="index.html">Ana Sayfa</a>
    <a href="forum.html">Forum</a>
    <a href="login.html">GiriÅŸ Yap</a>
    <a href="profile.html">Profilim</a>
  </nav>
</header>

<main class="page">

  <h1 class="page-title" id="pageTitle">Son Konular</h1>
  <p class="page-subtitle">
    GiriÅŸ yapmak zorunlu deÄŸil. Bir takma ad (nick) seÃ§, baÅŸlÄ±ÄŸÄ±nÄ± ve mesajÄ±nÄ± yaz.
  </p>

  <!-- YENÄ° KONU FORMU -->
  <section class="new-topic-box">
    <div class="new-topic-title">Yeni Konu AÃ§</div>

    <div class="form-row">
      <input type="text" id="nickInput" placeholder="Takma adÄ±n (Ã¶r: Nebride)">
      <input type="text" id="titleInput" placeholder="Konu baÅŸlÄ±ÄŸÄ±">
    </div>

    <div class="form-row">
      <select id="categoryInput" class="select-category">
        <option value="genel">âš¡ Genel Sohbet</option>
        <option value="oyun">ðŸŽ® Oyun Sohbeti</option>
        <option value="teknoloji">ðŸ’¡ Teknoloji KÃ¶ÅŸesi</option>
      </select>
    </div>

    <textarea id="messageInput" placeholder="MesajÄ±nÄ± yaz..."></textarea>

    <button class="btn-main" id="sendBtn">Konuyu GÃ¶nder</button>
  </section>

  <div id="forumContent"></div>

</main>

<footer>NebChat anonim forum â€¢ Ä°Ã§erik kullanÄ±cÄ±larÄ±n sorumluluÄŸundadÄ±r.</footer>

<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, serverTimestamp,
    query, orderBy, onSnapshot, where, limit
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBAwFSe0pud59OXpx1G5hQO9opA1f7Eg9Y",
    authDomain: "nebchat2.firebaseapp.com",
    projectId: "nebchat2",
    storageBucket: "nebchat2.firebasestorage.app",
    messagingSenderId: "46979426016",
    appId: "1:46979426016:web:fd1fbe341fff6970ae9285"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const categoryMap = {
    genel: "âš¡ Genel Sohbet",
    oyun: "ðŸŽ® Oyun Sohbeti",
    teknoloji: "ðŸ’¡ Teknoloji KÃ¶ÅŸesi"
  };

  const params = new URLSearchParams(window.location.search);
  const selectedCat = params.get("cat");

  const pageTitle = document.getElementById("pageTitle");
  const forumContent = document.getElementById("forumContent");

  const nickInput = document.getElementById("nickInput");
  const titleInput = document.getElementById("titleInput");
  const messageInput = document.getElementById("messageInput");
  const categoryInput = document.getElementById("categoryInput");
  const sendBtn = document.getElementById("sendBtn");

  // Yeni konu gÃ¶nderme
  sendBtn.addEventListener("click", async () => {
    const nick = nickInput.value.trim();
    const title = titleInput.value.trim();
    const message = messageInput.value.trim();
    const category = categoryInput.value;

    if (!nick || !title || !message) {
      alert("LÃ¼tfen tÃ¼m alanlarÄ± doldurun.");
      return;
    }

    await addDoc(collection(db, "posts"), {
      nick, title, message, category,
      createdAt: serverTimestamp(),
      replyCount: 0,
      lastReplyAt: null
    });

    messageInput.value = "";
    titleInput.value = "";
  });

  // ------------- ANA FORUM SAYFASI - KATEGORÄ° Ã–NÄ°ZLEME -------------
  async function renderCategoryPreview() {
    forumContent.innerHTML = "";

    for (const cat of ["genel", "oyun", "teknoloji"]) {
      const label = categoryMap[cat];

      const section = document.createElement("div");

      section.innerHTML = `
        <div class="category-title">${label}</div>
        <div id="list-${cat}" class="topic-list"></div>
        <a class="see-more" href="forum.html?cat=${cat}">TÃ¼mÃ¼nÃ¼ gÃ¶r â†’</a>
      `;

      forumContent.appendChild(section);

      const qCat = query(
        collection(db, "posts"),
        where("category", "==", cat),
        orderBy("createdAt", "desc"),
        limit(2)
      );

      const listDiv = section.querySelector(`#list-${cat}`);

      onSnapshot(qCat, (snapshot) => {
        listDiv.innerHTML = "";

        snapshot.forEach((docSnap) => {
          const d = docSnap.data();
          const id = docSnap.id;

          const item = document.createElement("a");
          item.className = "topic-item";
          item.href = `topic.html?id=${id}`;

          const lastTime = d.lastReplyAt?.toDate?.()
            ? d.lastReplyAt.toDate()
            : d.createdAt?.toDate?.();

          const formattedTime = lastTime
            ? lastTime.toLocaleString("tr-TR", {
                day: "2-digit",
                month: "2-digit",
                hour: "2-digit",
                minute: "2-digit"
              })
            : "";

          item.innerHTML = `
            <div class="topic-title">${label} â€” ${d.title}</div>
            <div class="topic-nick">Yazan: ${d.nick}</div>
            <div class="topic-message">${d.message}</div>
            <div class="topic-meta-line">
              ${d.replyCount || 0} yorum â€¢ Son yorum: ${formattedTime}
            </div>
          `;

          listDiv.appendChild(item);
        });
      });
    }
  }

  // ------------- KATEGORÄ° LÄ°STESÄ° SAYFASI -------------
  function renderCategoryPage(cat) {
    const label = categoryMap[cat];
    pageTitle.textContent = label;

    const q = query(
      collection(db, "posts"),
      where("category", "==", cat),
      orderBy("createdAt", "desc")
    );

    onSnapshot(q, (snapshot) => {
      forumContent.innerHTML = "";

      snapshot.forEach((docSnap) => {
        const d = docSnap.data();
        const id = docSnap.id;

        const item = document.createElement("a");
        item.className = "topic-item";
        item.href = `topic.html?id=${id}`;

        const lastTime = d.lastReplyAt?.toDate?.()
          ? d.lastReplyAt.toDate()
          : d.createdAt?.toDate?.();

        const formattedTime = lastTime
          ? lastTime.toLocaleString("tr-TR", {
              day: "2-digit",
              month: "2-digit",
              hour: "2-digit",
              minute: "2-digit"
            })
          : "";

        item.innerHTML = `
          <div class="topic-title">${label} â€” ${d.title}</div>
          <div class="topic-nick">Yazan: ${d.nick}</div>
          <div class="topic-message">${d.message}</div>
          <div class="topic-meta-line">
            ${d.replyCount || 0} yorum â€¢ Son yorum: ${formattedTime}
          </div>
        `;

        forumContent.appendChild(item);
      });
    });
  }

  // ------------- SAYFAYI BAÅžLAT -------------
  if (!selectedCat) {
    renderCategoryPreview();
  } else {
    renderCategoryPage(selectedCat);
  }

</script>

</body>
</html>
